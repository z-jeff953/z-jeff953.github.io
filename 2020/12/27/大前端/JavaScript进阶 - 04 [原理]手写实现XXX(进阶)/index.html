<!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1"><meta name="format-detection" content="telephone=no"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="black"><link rel="icon" href="/images/icons/favicon.png?v=2.1.1" type="image/png" sizes="16x16"><link rel="icon" href="/images/icons/favicon.png?v=2.1.1" type="image/png" sizes="32x32"><meta name="description" content="JavaScript进阶 - 04 [原理]手写实现XXX">
<meta property="og:type" content="article">
<meta property="og:title" content="JavaScript进阶 - 04 [原理]手写实现XXX">
<meta property="og:url" content="http://zjeff-953.gitee.io/zjeff/2020/12/27/%E5%A4%A7%E5%89%8D%E7%AB%AF/JavaScript%E8%BF%9B%E9%98%B6%20-%2004%20[%E5%8E%9F%E7%90%86]%E6%89%8B%E5%86%99%E5%AE%9E%E7%8E%B0XXX(%E8%BF%9B%E9%98%B6)/index.html">
<meta property="og:site_name" content="Jeff&#39;s blog">
<meta property="og:description" content="JavaScript进阶 - 04 [原理]手写实现XXX">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://raw.githubusercontent.com/z-jeff953/picsBed/main/image/20210509130614.png">
<meta property="article:published_time" content="2020-12-26T16:00:00.000Z">
<meta property="article:modified_time" content="2022-06-08T13:15:41.892Z">
<meta property="article:author" content="Jeffords zuo">
<meta property="article:tag" content="面向对象">
<meta property="article:tag" content="JavaScript">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://raw.githubusercontent.com/z-jeff953/picsBed/main/image/20210509130614.png"><title>JavaScript进阶 - 04 [原理]手写实现XXX | Jeff's blog</title><link ref="canonical" href="http://zjeff-953.gitee.io/zjeff/2020/12/27/%E5%A4%A7%E5%89%8D%E7%AB%AF/JavaScript%E8%BF%9B%E9%98%B6%20-%2004%20[%E5%8E%9F%E7%90%86]%E6%89%8B%E5%86%99%E5%AE%9E%E7%8E%B0XXX(%E8%BF%9B%E9%98%B6)/"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.12.1/css/all.min.css" type="text/css"><link rel="stylesheet" href="/css/index.css?v=2.1.1"><script>var Stun = window.Stun || {};
var CONFIG = {
  root: '/',
  algolia: undefined,
  fontIcon: {"prompt":{"success":"fas fa-check-circle","info":"fas fa-arrow-circle-right","warning":"fas fa-exclamation-circle","error":"fas fa-times-circle"},"copyBtn":"fas fa-copy"},
  sidebar: {"offsetTop":"20px","tocMaxDepth":5},
  header: {"enable":true,"showOnPost":false,"scrollDownIcon":false},
  postWidget: {"endText":true},
  nightMode: {"enable":true},
  back2top: {"enable":true},
  codeblock: {"style":"default","highlight":"light","wordWrap":false},
  reward: false,
  fancybox: false,
  zoomImage: {"gapAside":"20px"},
  galleryWaterfall: undefined,
  lazyload: false,
  pjax: undefined,
  externalLink: {"icon":{"enable":true,"name":"fas fa-external-link-alt"}},
  shortcuts: undefined,
  prompt: {"copyButton":"复制","copySuccess":"复制成功","copyError":"复制失败"},
  sourcePath: {"js":"js","css":"css","images":"images"},
};

window.CONFIG = CONFIG;</script><meta name="generator" content="Hexo 5.4.0"><link rel="alternate" href="/atom.xml" title="Jeff's blog" type="application/atom+xml">
</head><body><div class="container" id="container"><header class="header" id="header"><div class="header-inner header-inner--height header-inner--bgcolor"><nav class="header-nav header-nav--sticky"><div class="header-nav-inner"><div class="header-nav-menubtn"><i class="fas fa-bars"></i></div><div class="header-nav-menu"><div class="header-nav-menu-item"><a class="header-nav-menu-item__link" href="/"><span class="header-nav-menu-item__icon"><i class="fas fa-home"></i></span><span class="header-nav-menu-item__text">首页</span></a></div><div class="header-nav-menu-item"><a class="header-nav-menu-item__link" href="/archives/"><span class="header-nav-menu-item__icon"><i class="fas fa-folder-open"></i></span><span class="header-nav-menu-item__text">归档</span></a></div><div class="header-nav-menu-item"><a class="header-nav-menu-item__link" href="/categories/"><span class="header-nav-menu-item__icon"><i class="fas fa-layer-group"></i></span><span class="header-nav-menu-item__text">分类</span></a></div><div class="header-nav-menu-item"><a class="header-nav-menu-item__link" href="/tags/"><span class="header-nav-menu-item__icon"><i class="fas fa-tags"></i></span><span class="header-nav-menu-item__text">标签</span></a></div><div class="header-nav-menu-item"><a class="header-nav-menu-item__link" href="/reading/"><span class="header-nav-menu-item__icon"><i class="fas fa-book"></i></span><span class="header-nav-menu-item__text">阅读</span></a></div><div class="header-nav-menu-item"><a class="header-nav-menu-item__link" href="/about/"><span class="header-nav-menu-item__icon"><i class="fas fa-user-tie"></i></span><span class="header-nav-menu-item__text">关于</span></a></div></div><div class="header-nav-mode"><div class="mode"><div class="mode-track"><span class="mode-track-moon"></span><span class="mode-track-sun"></span></div><div class="mode-thumb"></div></div></div></div></nav></div></header><main class="main" id="main"><div class="main-inner"><div class="content-wrap" id="content-wrap"><div class="content" id="content"><!-- Just used to judge whether it is an article page--><div id="is-post"></div><div class="post"><header class="post-header"><h1 class="post-title">JavaScript进阶 - 04 [原理]手写实现XXX</h1><div class="post-meta"><span class="post-meta-item post-meta-item--createtime"><span class="post-meta-item__icon"><i class="far fa-calendar-plus"></i></span><span class="post-meta-item__info">发表于</span><span class="post-meta-item__value">2020-12-27</span></span><span class="post-meta-item post-meta-item--updatetime"><span class="post-meta-item__icon"><i class="far fa-calendar-check"></i></span><span class="post-meta-item__info">更新于</span><span class="post-meta-item__value">2022-06-08</span></span></div></header><div class="post-body">
        <h1 id="JavaScript进阶-04-原理-手写实现XXX-进阶"   >
          <a href="#JavaScript进阶-04-原理-手写实现XXX-进阶" class="heading-link"><i class="fas fa-link"></i></a>JavaScript进阶 - 04 [原理]手写实现XXX ( 进阶 )</h1>
      <span id="more"></span>

        <h2 id="3-Promise-全家桶"   >
          <a href="#3-Promise-全家桶" class="heading-link"><i class="fas fa-link"></i></a>3. Promise 全家桶</h2>
      <p>微任务队列调度是native代码实现的, 宏任务队列模拟效果, 有所缺憾</p>
<p>采用OOD编程思想, 先写Feture测试, 然后再写实现</p>

        <h3 id="3-1-分析特点和api"   >
          <a href="#3-1-分析特点和api" class="heading-link"><i class="fas fa-link"></i></a>3.1 分析特点和api</h3>
      <p><img src="https://raw.githubusercontent.com/z-jeff953/picsBed/main/image/20210509130614.png" alt="promises"></p>
<p>promise 有三种状态</p>
<ul>
<li>Pending</li>
<li>Resolved</li>
<li><p>Rejected</p>
<p>resolve，reject，all，race是静态方法，then，catch，finally是实例方法, 所以可以写一个类似接口的框架</p>
</li>
</ul>
<figure class="highlight js"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> PENDING = <span class="string">&#x27;PENDING&#x27;</span></span><br><span class="line"><span class="keyword">const</span> RESOLVED = <span class="string">&#x27;RESOLVED&#x27;</span></span><br><span class="line"><span class="keyword">const</span> REJECTED = <span class="string">&#x27;REJECTED&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Promise</span> </span>&#123;</span><br><span class="line">  <span class="title">constructor</span> (<span class="params">executor</span>) &#123;&#125;</span><br><span class="line">  then () &#123;&#125;</span><br><span class="line">  <span class="keyword">catch</span> () &#123;&#125;</span><br><span class="line">  <span class="keyword">finally</span> () &#123;&#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">static</span> resolve () &#123;&#125;</span><br><span class="line">  <span class="keyword">static</span> reject () &#123;&#125;</span><br><span class="line">  <span class="keyword">static</span> all () &#123;&#125;</span><br><span class="line">  <span class="keyword">static</span> race () &#123;&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

        <h3 id="3-2-实现Promise"   >
          <a href="#3-2-实现Promise" class="heading-link"><i class="fas fa-link"></i></a>3.2 实现Promise</h3>
      <p>复习一下基本使用</p>
<figure class="highlight js"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> test = <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    resolve(<span class="string">&#x27;123&#x27;</span>)</span><br><span class="line">  &#125;, <span class="number">1000</span>)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">test.then(</span><br><span class="line">  <span class="function"><span class="params">res</span> =&gt;</span> <span class="built_in">console</span>.log(res),</span><br><span class="line">  <span class="function"><span class="params">err</span> =&gt;</span> <span class="built_in">console</span>.log(err)</span><br><span class="line">)</span><br><span class="line"></span><br></pre></td></tr></table></div></figure>

        <h4 id="3-2-1-实现Promise的构造和then-catch-finally调用"   >
          <a href="#3-2-1-实现Promise的构造和then-catch-finally调用" class="heading-link"><i class="fas fa-link"></i></a>3.2.1 实现Promise的构造和then catch finally调用</h4>
      
        <h5 id="1-三个状态的转换和构造方法实现"   >
          <a href="#1-三个状态的转换和构造方法实现" class="heading-link"><i class="fas fa-link"></i></a>1 三个状态的转换和构造方法实现</h5>
      <p>只有一个状态转换过程: </p>
<blockquote>
<p>PADDING =&gt; FULLFILLED (RESOLVED/REJECTED)</p>
</blockquote>
<figure class="highlight js"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> PADDING = <span class="string">&#x27;PADDING&#x27;</span></span><br><span class="line"><span class="keyword">const</span> RESOLVED = <span class="string">&#x27;RESOLVED&#x27;</span></span><br><span class="line"><span class="keyword">const</span> REJECTED = <span class="string">&#x27;REJECTED&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyPromise</span> </span>&#123;</span><br><span class="line">  <span class="comment">// 三个成员变量</span></span><br><span class="line">  status = PENDING</span><br><span class="line">  value = <span class="literal">undefined</span></span><br><span class="line">  reason = <span class="literal">undefined</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// 一个函数参数</span></span><br><span class="line">  <span class="title">constructor</span> (<span class="params">executor</span>) &#123;</span><br><span class="line">    <span class="comment">// 定义函数参数的函数</span></span><br><span class="line">    <span class="keyword">const</span> resolve = <span class="function"><span class="params">value</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="comment">// 调用的时候进行状态转换, 注意先传值, 后转换状态</span></span><br><span class="line">      <span class="keyword">if</span> (<span class="built_in">this</span>.status === PENDING) &#123;</span><br><span class="line">        <span class="built_in">this</span>.value = value</span><br><span class="line">        <span class="built_in">this</span>.status = RESOLVED</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">const</span> reject = <span class="function"><span class="params">reason</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (<span class="built_in">this</span>.status === PENDING) &#123;</span><br><span class="line">        <span class="built_in">this</span>.reason = reason</span><br><span class="line">        <span class="built_in">this</span>.status = REJECTED</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 执行的异常处理</span></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      executor(resolve, reject)</span><br><span class="line">    &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">      reject(<span class="built_in">this</span>.reason)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>
<p><strong>这里我们可以看出一Promise的一个Feture, 就是 当Promise 构造的时候, 构造方法的参数 excutor函数就会执行</strong></p>

        <h5 id="2-then-方法"   >
          <a href="#2-then-方法" class="heading-link"><i class="fas fa-link"></i></a>2 then 方法</h5>
      <p>then 会接受 两个回调函数</p>

        <h6 id="2-1-根据状态-选择执行-onFulfilled-或者-onRejected"   >
          <a href="#2-1-根据状态-选择执行-onFulfilled-或者-onRejected" class="heading-link"><i class="fas fa-link"></i></a>2.1 根据状态 选择执行 onFulfilled 或者 onRejected</h6>
      <figure class="highlight js"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyPromise</span></span>&#123;</span><br><span class="line">  ...</span><br><span class="line">  </span><br><span class="line">  then (onFulfilled, onRejected) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">this</span>.status === RESOLVED) &#123;</span><br><span class="line">      onFulfilled(<span class="built_in">this</span>.value)</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="built_in">this</span>.status === REJECTED) &#123;</span><br><span class="line">      onRejected(<span class="built_in">this</span>.reason)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>
<p>测试一下</p>
<figure class="highlight js"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">new</span> MyPromise(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">  resolve(<span class="string">&#x27;000&#x27;</span>)</span><br><span class="line">&#125;).then(</span><br><span class="line">  <span class="function"><span class="params">res</span> =&gt;</span> <span class="built_in">console</span>.log(res),</span><br><span class="line">  <span class="function"><span class="params">err</span> =&gt;</span> <span class="built_in">console</span>.log(err)</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">new</span> MyPromise(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    resolve(<span class="string">&#x27;123&#x27;</span>)</span><br><span class="line">  &#125;, <span class="number">1000</span>)</span><br><span class="line">&#125;).then(</span><br><span class="line">  <span class="function"><span class="params">res</span> =&gt;</span> <span class="built_in">console</span>.log(res),</span><br><span class="line">  <span class="function"><span class="params">err</span> =&gt;</span> <span class="built_in">console</span>.log(err)</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="built_in">console</span>.log(<span class="number">321</span>)</span><br></pre></td></tr></table></div></figure>
<p>输出是</p>
<blockquote>
<p>000<br>321</p>
</blockquote>
<p>现在的版本是同步的, 有两个问题</p>
<ol>
<li>then 内的处理函数是在promise构造完成后就马上执行的, 会优于主线程其他任务</li>
<li>excutor 内部异步任务尚未执行就调用then , resolve 在一秒后才会执行, then的时候还是padding状态, 这时啥都不会执行</li>
</ol>

        <h6 id="2-2-解决-then-回调函数的执行时机"   >
          <a href="#2-2-解决-then-回调函数的执行时机" class="heading-link"><i class="fas fa-link"></i></a>2.2 解决 then 回调函数的执行时机</h6>
      <p>这个问题需要把then里的onResolve和onRejected都压入宏任务队列, 这样就能实现调用then的时候是主线程都执行完了的时候</p>
<figure class="highlight js"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">then (onFulfilled, onRejected) &#123;</span><br><span class="line">  <span class="keyword">if</span> (<span class="built_in">this</span>.status === RESOLVED) &#123;</span><br><span class="line">    <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">      onFulfilled(<span class="built_in">this</span>.value)</span><br><span class="line">    &#125;, <span class="number">0</span>)</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="built_in">this</span>.status === REJECTED) &#123;</span><br><span class="line">    <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">      onRejected(<span class="built_in">this</span>.reason)</span><br><span class="line">    &#125;, <span class="number">0</span>)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

        <h6 id="2-3-解决-excutor-内部异步任务尚未执行就调用then的问题"   >
          <a href="#2-3-解决-excutor-内部异步任务尚未执行就调用then的问题" class="heading-link"><i class="fas fa-link"></i></a>2.3 解决 excutor 内部异步任务尚未执行就调用then的问题</h6>
      <p>所以这里我们使用一个发布订阅模式解决这个问题</p>
<p>then是发布者, 发布resolve之后的任务, 轮到resolve执行的时候就把发布的任务拿来执行</p>
<figure class="highlight js"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyPromise</span> </span>&#123;</span><br><span class="line">  ...</span><br><span class="line">  <span class="comment">// 发布订阅模式, then的时候如果在padding, 就推入队列, </span></span><br><span class="line">  <span class="comment">// 调用then里对应的函数的时候就执行队列中的任务</span></span><br><span class="line">  onFulfilledQue = []</span><br><span class="line">  onRejectedQue = []</span><br><span class="line"></span><br><span class="line">  <span class="title">constructor</span> (<span class="params">executor</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> resolve = <span class="function"><span class="params">value</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (<span class="built_in">this</span>.status === PADDING) &#123;</span><br><span class="line">        <span class="built_in">this</span>.value = value</span><br><span class="line">        <span class="built_in">this</span>.status = RESOLVED</span><br><span class="line">        <span class="comment">// 订阅, 等到调用resolve的时候再把之前入队的任务拿出来执行</span></span><br><span class="line">        <span class="built_in">this</span>.onFulfilledQue.forEach(<span class="function"><span class="params">fn</span> =&gt;</span> fn())</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">const</span> reject = <span class="function"><span class="params">reason</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (<span class="built_in">this</span>.status === PADDING) &#123;</span><br><span class="line">        <span class="built_in">this</span>.reason = reason</span><br><span class="line">        <span class="built_in">this</span>.status = REJECTED</span><br><span class="line">        <span class="comment">// 订阅, 等到调用reject的时候再把之前入队的任务拿出来执行</span></span><br><span class="line">        <span class="built_in">this</span>.onRejectedQue.forEach(<span class="function"><span class="params">fn</span> =&gt;</span> fn())</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      executor(resolve, reject)</span><br><span class="line">    &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">      reject(<span class="built_in">this</span>.reason)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  then (onFulfilled, onRejected) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">this</span>.status === RESOLVED) &#123;</span><br><span class="line">      <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">        onFulfilled(<span class="built_in">this</span>.value)</span><br><span class="line">      &#125;, <span class="number">0</span>)</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="built_in">this</span>.status === REJECTED) &#123;</span><br><span class="line">      <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">        onRejected(<span class="built_in">this</span>.reason)</span><br><span class="line">      &#125;, <span class="number">0</span>)</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="comment">// 此时 this.status === PADDING</span></span><br><span class="line">      <span class="comment">// 如果调用then的时候还在padding就压入队列, 发布</span></span><br><span class="line">      <span class="built_in">this</span>.onFulfilledQue.push(<span class="function">() =&gt;</span> onFulfilled(<span class="built_in">this</span>.value))</span><br><span class="line">      <span class="built_in">this</span>.onRejectedQue.push(<span class="function">() =&gt;</span> onRejected(<span class="built_in">this</span>.reason))</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>
<p>此时就可以 得到正确的 结果了</p>
<blockquote>
<p>321<br>000<br>123</p>
</blockquote>

        <h6 id="2-4-实现Promise的then方法链式调用"   >
          <a href="#2-4-实现Promise的then方法链式调用" class="heading-link"><i class="fas fa-link"></i></a>2.4 实现Promise的then方法链式调用</h6>
      <p>链式调用的feture</p>
<blockquote>
<p> <code>then</code> must return a promise</p>
<figure class="highlight js"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">promise2 = promise1.then(onFulfilled,onRejected)</span><br></pre></td></tr></table></div></figure>
<ul>
<li>If either <code>onFulfilled</code> or <code>onRejected</code> returns a value <code>x</code>, run the Promise Resolution Procedure <code>[[Resolve]](promise2, x)</code>.</li>
<li>If either <code>onFulfilled</code> or <code>onRejected</code> throws an exception <code>e</code>, <code>promise2</code> must be rejected with <code>e</code> as the reason.</li>
<li>If <code>onFulfilled</code> is not a function and <code>promise1</code> is fulfilled, <code>promise2</code> must be fulfilled with the same value as <code>promise1</code>.</li>
<li>If <code>onRejected</code> is not a function and <code>promise1</code> is rejected, <code>promise2</code> must be rejected with the same reason as <code>promise1</code>.</li>
</ul>
</blockquote>
<p>测试代码</p>
<figure class="highlight js"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">new</span> MyPromise(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    resolve(<span class="string">&#x27;123&#x27;</span>)</span><br><span class="line">  &#125;, <span class="number">1000</span>)</span><br><span class="line">&#125;)</span><br><span class="line">  .then(</span><br><span class="line">    <span class="function"><span class="params">res</span> =&gt;</span> (<span class="built_in">console</span>.log(<span class="string">&#x27;then1&#x27;</span>, res), res),</span><br><span class="line">    <span class="function"><span class="params">err</span> =&gt;</span> <span class="built_in">console</span>.log(err)</span><br><span class="line">  )</span><br><span class="line">  .then(</span><br><span class="line">    <span class="function"><span class="params">res</span> =&gt;</span> <span class="built_in">console</span>.log(<span class="string">&#x27;then2&#x27;</span>, res),</span><br><span class="line">    <span class="function"><span class="params">err</span> =&gt;</span> <span class="built_in">console</span>.log(err)</span><br><span class="line">  )</span><br><span class="line"></span><br></pre></td></tr></table></div></figure>
<p>这时会报错, 因为then返回的是undefined</p>
<p>如果<code>return this</code>, 你拿到的不是上个then的返回值, 所以不可以</p>
<p>我们可以返回一个新的Promise, 然后在里面执行一些内容, 来更新promise的state和value</p>
<p>新的then: </p>
<figure class="highlight js"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">then (onFulfilled, onRejected) &#123;</span><br><span class="line">   <span class="comment">// 返回的Promise</span></span><br><span class="line">   <span class="keyword">const</span> newPromise = <span class="keyword">new</span> MyPromise(<span class="function">(<span class="params">newResolve, newReject</span>) =&gt;</span> &#123;</span><br><span class="line">     <span class="keyword">if</span> (<span class="built_in">this</span>.status === RESOLVED) &#123;</span><br><span class="line">       <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">         <span class="comment">// 对返回的新Promise的newResolve和newReject进行处理</span></span><br><span class="line">         executeNewPromise(</span><br><span class="line">           onFulfilled(<span class="built_in">this</span>.value),</span><br><span class="line">           newPromise,</span><br><span class="line">           newResolve,</span><br><span class="line">           newReject</span><br><span class="line">         )</span><br><span class="line">       &#125;, <span class="number">0</span>)</span><br><span class="line">     &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="built_in">this</span>.status === REJECTED) &#123;</span><br><span class="line">       <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">         executeNewPromise(</span><br><span class="line">           onRejected(<span class="built_in">this</span>.reason),</span><br><span class="line">           newPromise,</span><br><span class="line">           newResolve,</span><br><span class="line">           newReject</span><br><span class="line">         )</span><br><span class="line">       &#125;, <span class="number">0</span>)</span><br><span class="line">     &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">       <span class="comment">/// 此时 this.status === PADDING</span></span><br><span class="line">       <span class="comment">/// 如果调用then的时候还在padding就压入队列, 发布</span></span><br><span class="line">       <span class="built_in">this</span>.onResolvedQue.push(<span class="function">() =&gt;</span></span><br><span class="line">         executeNewPromise(</span><br><span class="line">           onFulfilled(<span class="built_in">this</span>.value),</span><br><span class="line">           newPromise,</span><br><span class="line">           newResolve,</span><br><span class="line">           newReject</span><br><span class="line">         )</span><br><span class="line">       )</span><br><span class="line">       <span class="built_in">this</span>.onRejectedQue.push(<span class="function">() =&gt;</span></span><br><span class="line">         executeNewPromise(</span><br><span class="line">           onRejected(<span class="built_in">this</span>.reason),</span><br><span class="line">           newPromise,</span><br><span class="line">           newResolve,</span><br><span class="line">           newReject</span><br><span class="line">         )</span><br><span class="line">       )</span><br><span class="line">     &#125;</span><br><span class="line">   &#125;)</span><br><span class="line">   <span class="keyword">return</span> newPromise</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></div></figure>
<p>其中用来更新newPromise的函数</p>
<figure class="highlight js"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// then返回的新promise的executor的参数执行的处理函数</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">executeNewPromise</span> (<span class="params">value, newPromise, resolve, reject</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// 如果返回 then 返回的 newPromise 报错</span></span><br><span class="line">  <span class="keyword">if</span> (value === newPromise)</span><br><span class="line">    <span class="keyword">return</span> reject(</span><br><span class="line">      <span class="keyword">new</span> <span class="built_in">TypeError</span>(<span class="string">&#x27;Chaining cycle detected for promise #&lt;Promise&gt;&#x27;</span>)</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 如果then的处理函数返回的是promise</span></span><br><span class="line">  <span class="comment">// 就执行promise的then, 直到value不是promise的时候修改新promise的值</span></span><br><span class="line">  <span class="keyword">if</span> (value <span class="keyword">instanceof</span> MyPromise)</span><br><span class="line">    value.then(</span><br><span class="line">      <span class="function"><span class="params">value</span> =&gt;</span> executeNewPromise(value, newPromise, resolve, reject),</span><br><span class="line">      <span class="function"><span class="params">e</span> =&gt;</span> reject(e)</span><br><span class="line">    )</span><br><span class="line">  <span class="comment">// 剩下的情况: value不是对象, 不是函数, 不是promise</span></span><br><span class="line">  resolve(value)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

        <h5 id="3-catch-方法和异常处理"   >
          <a href="#3-catch-方法和异常处理" class="heading-link"><i class="fas fa-link"></i></a>3 catch 方法和异常处理</h5>
      <p>excutor和onFulfilled都是回调函数, 如果他们出错了怎么处理呢? </p>
<p>测试用例: </p>
<figure class="highlight js"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">new</span> MyPromise(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    resolve(<span class="string">&#x27;123&#x27;</span>)</span><br><span class="line">  &#125;, <span class="number">1000</span>)</span><br><span class="line">&#125;)</span><br><span class="line">  .then(</span><br><span class="line">    <span class="function"><span class="params">res</span> =&gt;</span> (<span class="built_in">console</span>.log(<span class="string">&#x27;then1&#x27;</span>, res), res),</span><br><span class="line">    <span class="function"><span class="params">err</span> =&gt;</span> <span class="built_in">console</span>.log(err)</span><br><span class="line">  )</span><br><span class="line">  .then(</span><br><span class="line">    <span class="function"><span class="params">res</span> =&gt;</span> <span class="built_in">console</span>.log(<span class="string">&#x27;then2&#x27;</span>, res),</span><br><span class="line">    <span class="function"><span class="params">err</span> =&gt;</span> <span class="built_in">console</span>.log(err)</span><br><span class="line">  )</span><br><span class="line">  .then(<span class="function"><span class="params">res</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">&#x27;err&#x27;</span>)</span><br><span class="line">  &#125;)</span><br><span class="line">  .then(<span class="built_in">console</span>.log, <span class="built_in">console</span>.log)</span><br><span class="line"><span class="comment">//.catch(console.log)</span></span><br></pre></td></tr></table></div></figure>

        <h6 id="3-1-增加对于未知回调函数的的异常处理"   >
          <a href="#3-1-增加对于未知回调函数的的异常处理" class="heading-link"><i class="fas fa-link"></i></a>3.1 增加对于未知回调函数的的异常处理</h6>
      <p>首先我们在每个未知的回调函数上进行try-catch处理一下</p>
<figure class="highlight js"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 两类三个状态</span></span><br><span class="line"><span class="keyword">const</span> PADDING = <span class="string">&#x27;PADDING&#x27;</span></span><br><span class="line"><span class="keyword">const</span> RESOLVED = <span class="string">&#x27;RESOLVED&#x27;</span></span><br><span class="line"><span class="keyword">const</span> REJECTED = <span class="string">&#x27;REJECTED&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// then返回的新promise的executor的参数执行的处理函数</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">executeNewPromise</span> (<span class="params">value, newPromise, resolve, reject</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// 如果返回 then 返回的 newPromise 报错</span></span><br><span class="line">  <span class="keyword">if</span> (value === newPromise)</span><br><span class="line">    <span class="keyword">return</span> reject(</span><br><span class="line">      <span class="keyword">new</span> <span class="built_in">TypeError</span>(<span class="string">&#x27;Chaining cycle detected for promise #&lt;Promise&gt;&#x27;</span>)</span><br><span class="line">    )</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="comment">// 如果then的处理函数返回的是promise</span></span><br><span class="line">    <span class="comment">// 就执行promise的then, 直到value不是promise的时候修改新promise的值</span></span><br><span class="line">    <span class="keyword">if</span> (value <span class="keyword">instanceof</span> MyPromise)</span><br><span class="line">      value.then(</span><br><span class="line">        <span class="function"><span class="params">value</span> =&gt;</span> executeNewPromise(value, newPromise, resolve, reject),</span><br><span class="line">        <span class="function"><span class="params">e</span> =&gt;</span> reject(e)</span><br><span class="line">      )</span><br><span class="line">      <span class="comment">// 剩下的情况: value不是对象, 不是函数, 不是promise</span></span><br><span class="line">  	resolve(value)</span><br><span class="line">  &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">    reject(e)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyPromise</span> </span>&#123;</span><br><span class="line">  <span class="comment">// 成员变量</span></span><br><span class="line">  status = PADDING</span><br><span class="line">  value = <span class="literal">undefined</span></span><br><span class="line">  reason = <span class="literal">undefined</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">/// 发布订阅模式, then的时候如果在padding, 就推入队列,</span></span><br><span class="line">  <span class="comment">/// 调用then里对应的函数的时候就执行队列中的任务</span></span><br><span class="line">  onResolvedQue = []</span><br><span class="line">  onRejectedQue = []</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 一个函数参数</span></span><br><span class="line">  <span class="title">constructor</span> (<span class="params">executor</span>) &#123;</span><br><span class="line">    <span class="comment">// 定义函数参数的函数</span></span><br><span class="line">    <span class="keyword">const</span> resolve = <span class="function"><span class="params">value</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="comment">// 调用的时候进行状态转换, 注意先传值, 后转换状态</span></span><br><span class="line">      <span class="keyword">if</span> (<span class="built_in">this</span>.status === PADDING) &#123;</span><br><span class="line">        <span class="built_in">this</span>.value = value</span><br><span class="line">        <span class="built_in">this</span>.status = RESOLVED</span><br><span class="line">        <span class="comment">/// 订阅, 等到调用resolve的时候再把之前入队的任务拿出来执行</span></span><br><span class="line">        <span class="built_in">this</span>.onResolvedQue.forEach(<span class="function"><span class="params">fn</span> =&gt;</span> fn())</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">const</span> reject = <span class="function"><span class="params">reason</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (<span class="built_in">this</span>.status === PADDING) &#123;</span><br><span class="line">        <span class="built_in">this</span>.reason = reason</span><br><span class="line">        <span class="built_in">this</span>.status = REJECTED</span><br><span class="line">        <span class="built_in">this</span>.onRejectedQue.forEach(<span class="function"><span class="params">fn</span> =&gt;</span> fn())</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      executor(resolve, reject)</span><br><span class="line">    &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">      reject(<span class="built_in">this</span>.reason)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  then (onFulfilled, onRejected) &#123;</span><br><span class="line">    <span class="comment">// 返回的Promise</span></span><br><span class="line">    <span class="keyword">const</span> newPromise = <span class="keyword">new</span> MyPromise(<span class="function">(<span class="params">newResolve, newReject</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (<span class="built_in">this</span>.status === RESOLVED) &#123;</span><br><span class="line">        <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">          <span class="comment">// 对返回的新Promise的newResolve和newReject进行处理</span></span><br><span class="line">          <span class="keyword">try</span> &#123;</span><br><span class="line">            executeNewPromise(</span><br><span class="line">              onFulfilled(<span class="built_in">this</span>.value),</span><br><span class="line">              newPromise,</span><br><span class="line">              newResolve,</span><br><span class="line">              newReject</span><br><span class="line">            )</span><br><span class="line">          &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">            newReject(e)</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;, <span class="number">0</span>)</span><br><span class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="built_in">this</span>.status === REJECTED) &#123;</span><br><span class="line">        <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">          <span class="keyword">try</span> &#123;</span><br><span class="line">            executeNewPromise(</span><br><span class="line">              onRejected(<span class="built_in">this</span>.reason),</span><br><span class="line">              newPromise,</span><br><span class="line">              newResolve,</span><br><span class="line">              newReject</span><br><span class="line">            )</span><br><span class="line">          &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">            newReject(e)</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;, <span class="number">0</span>)</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">/// 此时 this.status === PADDING</span></span><br><span class="line">        <span class="comment">/// 如果调用then的时候还在padding就压入队列, 发布</span></span><br><span class="line">        <span class="built_in">this</span>.onResolvedQue.push(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">          <span class="keyword">try</span> &#123;</span><br><span class="line">            executeNewPromise(</span><br><span class="line">              onFulfilled(<span class="built_in">this</span>.value),</span><br><span class="line">              newPromise,</span><br><span class="line">              newResolve,</span><br><span class="line">              newReject</span><br><span class="line">            )</span><br><span class="line">          &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">            newReject(e)</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;)</span><br><span class="line">        <span class="built_in">this</span>.onRejectedQue.push(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">          <span class="keyword">try</span> &#123;</span><br><span class="line">            executeNewPromise(</span><br><span class="line">              onRejected(<span class="built_in">this</span>.reason),</span><br><span class="line">              newPromise,</span><br><span class="line">              newResolve,</span><br><span class="line">              newReject</span><br><span class="line">            )</span><br><span class="line">          &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">            newReject(e)</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">    <span class="keyword">return</span> newPromise</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>
<p>然后我们需要判断then的时候, 如果有reject, 但是then里没有何时的处理函数的时候, 在新的promise中把reason原样扔回去</p>

        <h6 id="3-2-如果then没有处理异常处理函数-或者没有value处理函数-就在新的promise中返回他"   >
          <a href="#3-2-如果then没有处理异常处理函数-或者没有value处理函数-就在新的promise中返回他" class="heading-link"><i class="fas fa-link"></i></a>3.2 如果then没有处理异常处理函数, 或者没有value处理函数, 就在新的promise中返回他</h6>
      <figure class="highlight js"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line">then (onFulfilled, onRejected) &#123;</span><br><span class="line">  onFulfilled =</span><br><span class="line">    <span class="keyword">typeof</span> onFulfilled === <span class="string">&#x27;function&#x27;</span> ? onFulfilled : <span class="function">() =&gt;</span> <span class="built_in">this</span>.value</span><br><span class="line">  onRejected =</span><br><span class="line">    <span class="keyword">typeof</span> onRejected === <span class="string">&#x27;function&#x27;</span></span><br><span class="line">      ? onRejected</span><br><span class="line">      : <span class="function">() =&gt;</span> &#123;</span><br><span class="line">          <span class="keyword">throw</span> <span class="built_in">this</span>.reason</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 返回的Promise</span></span><br><span class="line">  <span class="keyword">const</span> newPromise = <span class="keyword">new</span> MyPromise(<span class="function">(<span class="params">newResolve, newReject</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> handleResolve = <span class="function">() =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">        resolvePromise(</span><br><span class="line">          newPromise,</span><br><span class="line">          onFulfilled(<span class="built_in">this</span>.value),</span><br><span class="line">          newResolve,</span><br><span class="line">          newReject</span><br><span class="line">        )</span><br><span class="line">      &#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">        newReject(error)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> handleReject = <span class="function">() =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">        resolvePromise(</span><br><span class="line">          newPromise,</span><br><span class="line">          onRejected(<span class="built_in">this</span>.reason),</span><br><span class="line">          newResolve,</span><br><span class="line">          newReject</span><br><span class="line">        )</span><br><span class="line">      &#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">        newReject(error)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">this</span>.status === RESOLVED) &#123;</span><br><span class="line">      <span class="built_in">setTimeout</span>(handleResolve, <span class="number">0</span>)</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="built_in">this</span>.status === REJECTED) &#123;</span><br><span class="line">      <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> handleReject(), <span class="number">0</span>)</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="comment">/// 此时 this.status === PADDING</span></span><br><span class="line">      <span class="comment">/// 如果调用then的时候还在padding就压入队列, 发布</span></span><br><span class="line">      <span class="built_in">this</span>.onResolvedQue.push(handleResolve)</span><br><span class="line">      <span class="built_in">this</span>.onRejectedQue.push(handleReject)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;)</span><br><span class="line">  <span class="keyword">return</span> newPromise</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

        <h6 id="3-3-catch"   >
          <a href="#3-3-catch" class="heading-link"><i class="fas fa-link"></i></a>3.3 catch</h6>
      <figure class="highlight js"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">catch</span> (onRejected) &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">this</span>.then(<span class="literal">undefined</span>, onRejected)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

        <h5 id="4-finally"   >
          <a href="#4-finally" class="heading-link"><i class="fas fa-link"></i></a>4. finally</h5>
      <figure class="highlight js"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">finally</span> (onFinally) &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">this</span>.then(</span><br><span class="line">    <span class="function"><span class="params">value</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="built_in">Promise</span>.resolve(onFinally()).then(<span class="function">() =&gt;</span> value)</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="function"><span class="params">reason</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="built_in">Promise</span>.resolve(onFinally()).then(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">throw</span> reason</span><br><span class="line">      &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">  )</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

        <h4 id="3-2-2-Promise-A-确认"   >
          <a href="#3-2-2-Promise-A-确认" class="heading-link"><i class="fas fa-link"></i></a>3.2.2 Promise/A+ 确认</h4>
      <p><span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://promisesaplus.com/#notes" >https://promisesaplus.com/#notes</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<figure class="highlight js"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// then返回的新promise的executor的参数执行的处理函数</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">resolvePromise</span> (<span class="params">newPromise, valueX, resolve, reject</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// Promise/A+ 2.3.1</span></span><br><span class="line">  <span class="comment">// If promise and x refer to the same object, reject promise with a TypeError as the reason.</span></span><br><span class="line">  <span class="keyword">if</span> (valueX === newPromise)</span><br><span class="line">    <span class="keyword">return</span> reject(</span><br><span class="line">      <span class="keyword">new</span> <span class="built_in">TypeError</span>(<span class="string">&#x27;Chaining cycle detected for promise #&lt;Promise&gt;&#x27;</span>)</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="comment">// 如果then的处理函数返回的是promise</span></span><br><span class="line">    <span class="comment">// 就执行promise的then, 直到value不是promise的时候修改新promise的值</span></span><br><span class="line">    <span class="keyword">if</span> (valueX <span class="keyword">instanceof</span> MyPromise)</span><br><span class="line">      valueX.then(</span><br><span class="line">        <span class="function"><span class="params">value</span> =&gt;</span> resolvePromise(newPromise, value, resolve, reject),</span><br><span class="line">        reject</span><br><span class="line">      )</span><br><span class="line">    <span class="keyword">else</span> resolve(valueX)</span><br><span class="line">  &#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">    <span class="comment">// If/when rejectPromise is called with a reason r, reject promise with r.</span></span><br><span class="line">    reject(error)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

        <h5 id="迄今为止的实现和测试用例"   >
          <a href="#迄今为止的实现和测试用例" class="heading-link"><i class="fas fa-link"></i></a>迄今为止的实现和测试用例</h5>
      <figure class="highlight js"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 两类三个状态</span></span><br><span class="line"><span class="keyword">const</span> PADDING = <span class="string">&#x27;PADDING&#x27;</span></span><br><span class="line"><span class="keyword">const</span> RESOLVED = <span class="string">&#x27;RESOLVED&#x27;</span></span><br><span class="line"><span class="keyword">const</span> REJECTED = <span class="string">&#x27;REJECTED&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// then返回的新promise的executor的参数执行的处理函数</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">resolvePromise</span> (<span class="params">newPromise, valueX, resolve, reject</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// Promise/A+ 2.3.1</span></span><br><span class="line">  <span class="comment">// If promise and x refer to the same object, reject promise with a TypeError as the reason.</span></span><br><span class="line">  <span class="keyword">if</span> (valueX === newPromise)</span><br><span class="line">    <span class="keyword">return</span> reject(</span><br><span class="line">      <span class="keyword">new</span> <span class="built_in">TypeError</span>(<span class="string">&#x27;Chaining cycle detected for promise #&lt;Promise&gt;&#x27;</span>)</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="comment">// 如果then的处理函数返回的是promise</span></span><br><span class="line">    <span class="comment">// 就执行promise的then, 直到value不是promise的时候修改新promise的值</span></span><br><span class="line">    <span class="keyword">if</span> (valueX <span class="keyword">instanceof</span> MyPromise)</span><br><span class="line">      valueX.then(</span><br><span class="line">        <span class="function"><span class="params">value</span> =&gt;</span> resolvePromise(newPromise, value, resolve, reject),</span><br><span class="line">        reject</span><br><span class="line">      )</span><br><span class="line">    <span class="keyword">else</span> resolve(valueX)</span><br><span class="line">  &#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">    <span class="comment">// If/when rejectPromise is called with a reason r, reject promise with r.</span></span><br><span class="line">    reject(error)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyPromise</span> </span>&#123;</span><br><span class="line">  <span class="comment">// 成员变量</span></span><br><span class="line">  status = PADDING</span><br><span class="line">  value = <span class="literal">undefined</span></span><br><span class="line">  reason = <span class="literal">undefined</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">/// 发布订阅模式, then的时候如果在padding, 就推入队列,</span></span><br><span class="line">  <span class="comment">/// 调用then里对应的函数的时候就执行队列中的任务</span></span><br><span class="line">  onResolvedQue = []</span><br><span class="line">  onRejectedQue = []</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 一个函数参数</span></span><br><span class="line">  <span class="title">constructor</span> (<span class="params">executor</span>) &#123;</span><br><span class="line">    <span class="comment">// 定义函数参数的函数</span></span><br><span class="line">    <span class="keyword">const</span> resolve = <span class="function"><span class="params">value</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="comment">// 调用的时候进行状态转换, 注意先传值, 后转换状态</span></span><br><span class="line">      <span class="keyword">if</span> (<span class="built_in">this</span>.status === PADDING) &#123;</span><br><span class="line">        <span class="built_in">this</span>.value = value</span><br><span class="line">        <span class="built_in">this</span>.status = RESOLVED</span><br><span class="line">        <span class="comment">/// 订阅, 等到调用resolve的时候再把之前入队的任务拿出来执行</span></span><br><span class="line">        <span class="built_in">this</span>.onResolvedQue.forEach(<span class="function"><span class="params">fn</span> =&gt;</span> fn())</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">const</span> reject = <span class="function"><span class="params">reason</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (<span class="built_in">this</span>.status === PADDING) &#123;</span><br><span class="line">        <span class="built_in">this</span>.reason = reason</span><br><span class="line">        <span class="built_in">this</span>.status = REJECTED</span><br><span class="line">        <span class="built_in">this</span>.onRejectedQue.forEach(<span class="function"><span class="params">fn</span> =&gt;</span> fn())</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      executor(resolve, reject)</span><br><span class="line">    &#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">      reject(error)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  then (onFulfilled, onRejected) &#123;</span><br><span class="line">    onFulfilled =</span><br><span class="line">      <span class="keyword">typeof</span> onFulfilled === <span class="string">&#x27;function&#x27;</span> ? onFulfilled : <span class="function">() =&gt;</span> <span class="built_in">this</span>.value</span><br><span class="line">    onRejected =</span><br><span class="line">      <span class="keyword">typeof</span> onRejected === <span class="string">&#x27;function&#x27;</span></span><br><span class="line">        ? onRejected</span><br><span class="line">        : <span class="function">() =&gt;</span> &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="built_in">this</span>.reason</span><br><span class="line">          &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 返回的Promise</span></span><br><span class="line">    <span class="keyword">const</span> newPromise = <span class="keyword">new</span> MyPromise(<span class="function">(<span class="params">newResolve, newReject</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">const</span> handleResolve = <span class="function">() =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">          resolvePromise(</span><br><span class="line">            newPromise,</span><br><span class="line">            onFulfilled(<span class="built_in">this</span>.value),</span><br><span class="line">            newResolve,</span><br><span class="line">            newReject</span><br><span class="line">          )</span><br><span class="line">        &#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">          newReject(error)</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">const</span> handleReject = <span class="function">() =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">          resolvePromise(</span><br><span class="line">            newPromise,</span><br><span class="line">            onRejected(<span class="built_in">this</span>.reason),</span><br><span class="line">            newResolve,</span><br><span class="line">            newReject</span><br><span class="line">          )</span><br><span class="line">        &#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">          newReject(error)</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (<span class="built_in">this</span>.status === RESOLVED) &#123;</span><br><span class="line">        <span class="built_in">setTimeout</span>(handleResolve, <span class="number">0</span>)</span><br><span class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="built_in">this</span>.status === REJECTED) &#123;</span><br><span class="line">        <span class="built_in">setTimeout</span>(handleReject, <span class="number">0</span>)</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">/// 此时 this.status === PADDING</span></span><br><span class="line">        <span class="comment">/// 如果调用then的时候还在padding就压入队列, 发布</span></span><br><span class="line">        <span class="built_in">this</span>.onResolvedQue.push(handleResolve)</span><br><span class="line">        <span class="built_in">this</span>.onRejectedQue.push(handleReject)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">    <span class="keyword">return</span> newPromise</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">catch</span> (onRejected) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">this</span>.then(<span class="literal">undefined</span>, onRejected)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">finally</span> (onFinally) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">this</span>.then(</span><br><span class="line">      <span class="function"><span class="params">value</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">Promise</span>.resolve(onFinally()).then(<span class="function">() =&gt;</span> value)</span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="function"><span class="params">reason</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">Promise</span>.resolve(onFinally()).then(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">          <span class="keyword">throw</span> reason</span><br><span class="line">        &#125;)</span><br><span class="line">      &#125;</span><br><span class="line">    )</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">new</span> MyPromise(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    resolve(<span class="string">&#x27;123&#x27;</span>)</span><br><span class="line">  &#125;, <span class="number">1000</span>)</span><br><span class="line">&#125;)</span><br><span class="line">  .then(</span><br><span class="line">    <span class="function"><span class="params">res</span> =&gt;</span> (<span class="built_in">console</span>.log(<span class="string">&#x27;then1&#x27;</span>, res), res),</span><br><span class="line">    <span class="function"><span class="params">err</span> =&gt;</span> <span class="built_in">console</span>.log(<span class="string">&#x27;err1&#x27;</span>, err)</span><br><span class="line">  )</span><br><span class="line">  .then(</span><br><span class="line">    <span class="function"><span class="params">res</span> =&gt;</span> <span class="built_in">console</span>.log(<span class="string">&#x27;then2&#x27;</span>, res),</span><br><span class="line">    <span class="function"><span class="params">err</span> =&gt;</span> <span class="built_in">console</span>.log(<span class="string">&#x27;err2&#x27;</span>, err)</span><br><span class="line">  )</span><br><span class="line">  .then(<span class="function"><span class="params">res</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">      <span class="built_in">console</span>.log(<span class="string">&#x27;then3&#x27;</span>)</span><br><span class="line">    &#125;, <span class="number">0</span>)</span><br><span class="line">  &#125;)</span><br><span class="line">  .then(<span class="function"><span class="params">res</span> =&gt;</span> <span class="built_in">console</span>.log(<span class="string">&#x27;then4&#x27;</span>, res))</span><br><span class="line">  .then(<span class="function"><span class="params">res</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> MyPromise(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">        resolve(</span><br><span class="line">          <span class="keyword">new</span> MyPromise(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">            <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">              resolve(<span class="string">&#x27;123123&#x27;</span>)</span><br><span class="line">            &#125;, <span class="number">1000</span>)</span><br><span class="line">          &#125;)</span><br><span class="line">        )</span><br><span class="line">      &#125;, <span class="number">1000</span>)</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;)</span><br><span class="line">  .then(<span class="function"><span class="params">res</span> =&gt;</span> <span class="built_in">console</span>.log(<span class="string">&#x27;then5&#x27;</span>, res))</span><br><span class="line">  .catch(<span class="built_in">console</span>.log)</span><br><span class="line"></span><br><span class="line"><span class="built_in">console</span>.log(<span class="number">321</span>)</span><br></pre></td></tr></table></div></figure>

        <h4 id="3-2-3-兼容其他的-Promise-实现"   >
          <a href="#3-2-3-兼容其他的-Promise-实现" class="heading-link"><i class="fas fa-link"></i></a>3.2.3 兼容其他的 Promise 实现</h4>
      <p>因为Promise/A+ 有各种第三方实现, 如果兼容, 需要兼容的是, then回调中返回的是其他promise的情况( instanceof 不能判断出第三方promise), 所以修改的只有 <code>resolvePromise</code> 函数</p>
<figure class="highlight js"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">resolvePromise</span> (<span class="params">newPromise, valueX, newResolve, newReject</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// Promise/A+ 2.3.1</span></span><br><span class="line">  <span class="comment">// If promise and x refer to the same object, reject promise with a TypeError as the reason.</span></span><br><span class="line">  <span class="keyword">if</span> (valueX === newPromise)</span><br><span class="line">    <span class="keyword">return</span> newReject(</span><br><span class="line">      <span class="keyword">new</span> <span class="built_in">TypeError</span>(<span class="string">&#x27;Chaining cycle detected for promise #&lt;Promise&gt;&#x27;</span>)</span><br><span class="line">    )</span><br><span class="line">  <span class="comment">// Promise/A+ 2.3.3.3.3 只能调用一次</span></span><br><span class="line">  <span class="keyword">let</span> called = <span class="literal">false</span></span><br><span class="line">  <span class="comment">// 后续的条件要严格判断 保证代码能和别的库一起使用</span></span><br><span class="line"><span class="keyword">if</span> (x !== <span class="literal">null</span> &amp;&amp; (<span class="keyword">typeof</span> x === <span class="string">&#x27;object&#x27;</span> || <span class="keyword">typeof</span> x === <span class="string">&#x27;function&#x27;</span>))  &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="comment">// 为了判断 resolve 过的就不用再 reject 了（比如 reject 和 resolve 同时调用的时候）  Promise/A+ 2.3.3.1</span></span><br><span class="line">      <span class="keyword">const</span> then = valueX.then</span><br><span class="line">      <span class="keyword">if</span> (<span class="keyword">typeof</span> then === <span class="string">&#x27;function&#x27;</span>) &#123;</span><br><span class="line">        <span class="comment">// 不要写成 x.then，直接 then.call 就可以了 因为 x.then 会再次取值，Object.defineProperty  Promise/A+ 2.3.3.3</span></span><br><span class="line">        then.call(</span><br><span class="line">          valueX,</span><br><span class="line">          <span class="function"><span class="params">y</span> =&gt;</span> &#123;</span><br><span class="line">            <span class="comment">// 根据 promise 的状态决定是成功还是失败</span></span><br><span class="line">            <span class="keyword">if</span> (called) <span class="keyword">return</span></span><br><span class="line">            called = <span class="literal">true</span></span><br><span class="line">            <span class="comment">// 递归解析的过程（因为可能 promise 中还有 promise） Promise/A+ 2.3.3.3.1</span></span><br><span class="line">            resolvePromise(newPromise, y, newResolve, newReject)</span><br><span class="line">          &#125;,</span><br><span class="line">          <span class="function"><span class="params">r</span> =&gt;</span> &#123;</span><br><span class="line">            <span class="comment">// 只要失败就失败 Promise/A+ 2.3.3.3.2</span></span><br><span class="line">            <span class="keyword">if</span> (called) <span class="keyword">return</span></span><br><span class="line">            called = <span class="literal">true</span></span><br><span class="line">            newReject(r)</span><br><span class="line">          &#125;</span><br><span class="line">        )</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// 如果 x.then 是个普通值就直接返回 resolve 作为结果  Promise/A+ 2.3.3.4</span></span><br><span class="line">        newResolve(valueX)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">      <span class="comment">// Promise/A+ 2.3.3.2</span></span><br><span class="line">      <span class="keyword">if</span> (called) <span class="keyword">return</span></span><br><span class="line">      called = <span class="literal">true</span></span><br><span class="line">      newReject(e)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// 如果 x 是个普通值就直接返回 resolve 作为结果  Promise/A+ 2.3.4</span></span><br><span class="line">    newResolve(valueX)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

        <h4 id="3-2-4-promises-aplus-tests-测试并修复"   >
          <a href="#3-2-4-promises-aplus-tests-测试并修复" class="heading-link"><i class="fas fa-link"></i></a>3.2.4 promises-aplus-tests 测试并修复</h4>
      <p>1、先在后面加上下述代码</p>
<p>2、npm 有一个promises-aplus-tests插件 npm i promises-aplus-tests -g 可以全局安装 mac用户最前面加上sudo</p>
<p>3、命令行 promises-aplus-tests [js文件名] 即可验证</p>
<figure class="highlight js"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">MyPromise.defer = MyPromise.deferred = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">let</span> dfd = &#123;&#125;</span><br><span class="line">  dfd.promise = <span class="keyword">new</span> MyPromise(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">    dfd.resolve = resolve</span><br><span class="line">    dfd.reject = reject</span><br><span class="line">  &#125;)</span><br><span class="line">  <span class="keyword">return</span> dfd</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = MyPromise</span><br></pre></td></tr></table></div></figure>
<p>现在的结果</p>
<figure class="highlight js"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">866</span> passing (34s)</span><br><span class="line">  <span class="number">6</span> failing</span><br><span class="line"></span><br><span class="line">  <span class="number">1</span>) <span class="number">2.2</span><span class="number">.2</span>: If <span class="string">`onFulfilled`</span> is a <span class="function"><span class="keyword">function</span>, 2.2.2.2: <span class="title">it</span> <span class="title">must</span> <span class="title">not</span> <span class="title">be</span> <span class="title">called</span> <span class="title">before</span> `<span class="title">promise</span>` <span class="title">is</span> <span class="title">fulfilled</span> <span class="title">fulfilled</span> <span class="title">after</span> <span class="title">a</span> <span class="title">delay</span>:</span></span><br><span class="line"><span class="function">     <span class="title">Error</span>: <span class="title">timeout</span> <span class="title">of</span> 200<span class="title">ms</span> <span class="title">exceeded</span>. <span class="title">Ensure</span> <span class="title">the</span> <span class="title">done</span>(<span class="params"></span>) <span class="title">callback</span> <span class="title">is</span> <span class="title">being</span> <span class="title">called</span> <span class="title">in</span> <span class="title">this</span> <span class="title">test</span>.</span></span><br><span class="line"><span class="function">      <span class="title">at</span> <span class="title">Timeout</span>.&lt;<span class="title">anonymous</span>&gt; (<span class="params">D:\FrontEnd\NodeJS\node_global\node_modules\promises-aplus-tests\node_modules\mocha\lib\runnable.js:<span class="number">226</span>:<span class="number">19</span></span>)</span></span><br><span class="line"><span class="function">      <span class="title">at</span> <span class="title">listOnTimeout</span> (<span class="params">internal/timers.js:<span class="number">554</span>:<span class="number">17</span></span>)</span></span><br><span class="line"><span class="function">      <span class="title">at</span> <span class="title">processTimers</span> (<span class="params">internal/timers.js:<span class="number">497</span>:<span class="number">7</span></span>)</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">  2) 2.2.3: <span class="title">If</span> `<span class="title">onRejected</span>` <span class="title">is</span> <span class="title">a</span> <span class="function"><span class="keyword">function</span>, 2.2.3.2: <span class="title">it</span> <span class="title">must</span> <span class="title">not</span> <span class="title">be</span> <span class="title">called</span> <span class="title">before</span> `<span class="title">promise</span>` <span class="title">is</span> <span class="title">rejected</span> <span class="title">rejected</span> <span class="title">after</span> <span class="title">a</span> <span class="title">delay</span>:</span></span></span><br><span class="line"><span class="function"><span class="function">     <span class="title">Error</span>: <span class="title">timeout</span> <span class="title">of</span> 200<span class="title">ms</span> <span class="title">exceeded</span>. <span class="title">Ensure</span> <span class="title">the</span> <span class="title">done</span>(<span class="params"></span>) <span class="title">callback</span> <span class="title">is</span> <span class="title">being</span> <span class="title">called</span> <span class="title">in</span> <span class="title">this</span> <span class="title">test</span>.</span></span></span><br><span class="line"><span class="function"><span class="function">      <span class="title">at</span> <span class="title">Timeout</span>.&lt;<span class="title">anonymous</span>&gt; (<span class="params">D:\FrontEnd\NodeJS\node_global\node_modules\promises-aplus-tests\node_modules\mocha\lib\runnable.js:<span class="number">226</span>:<span class="number">19</span></span>)</span></span></span><br><span class="line"><span class="function"><span class="function">      <span class="title">at</span> <span class="title">listOnTimeout</span> (<span class="params">internal/timers.js:<span class="number">554</span>:<span class="number">17</span></span>)</span></span></span><br><span class="line"><span class="function"><span class="function">      <span class="title">at</span> <span class="title">processTimers</span> (<span class="params">internal/timers.js:<span class="number">497</span>:<span class="number">7</span></span>)</span></span></span><br><span class="line"><span class="function"><span class="function"></span></span></span><br><span class="line"><span class="function"><span class="function">  3) 2.2.4: `<span class="title">onFulfilled</span>` <span class="title">or</span> `<span class="title">onRejected</span>` <span class="title">must</span> <span class="title">not</span> <span class="title">be</span> <span class="title">called</span> <span class="title">until</span> <span class="title">the</span> <span class="title">execution</span> <span class="title">context</span> <span class="title">stack</span> <span class="title">contains</span> <span class="title">only</span> <span class="title">platform</span> <span class="title">code</span>. <span class="title">Clean</span>-<span class="title">stack</span> <span class="title">execution</span> <span class="title">ordering</span> <span class="title">tests</span> (<span class="params">fulfillment <span class="keyword">case</span></span>) <span class="title">when</span> `<span class="title">onFulfilled</span>` <span class="title">is</span> <span class="title">added</span> <span class="title">immediately</span> <span class="title">before</span> <span class="title">the</span> <span class="title">promise</span> <span class="title">is</span> <span class="title">fulfilled</span>:</span></span></span><br><span class="line"><span class="function"><span class="function"></span></span></span><br><span class="line"><span class="function"><span class="function">      <span class="title">AssertionError</span> [<span class="title">ERR_ASSERTION</span>]: <span class="title">Expected</span> <span class="title">values</span> <span class="title">to</span> <span class="title">be</span> <span class="title">strictly</span> <span class="title">equal</span>:</span></span></span><br><span class="line"><span class="function"><span class="function"></span></span></span><br><span class="line"><span class="function"><span class="function"><span class="title">true</span> !== <span class="title">false</span></span></span></span><br><span class="line"><span class="function"><span class="function"></span></span></span><br><span class="line"><span class="function"><span class="function">      + <span class="title">expected</span> - <span class="title">actual</span></span></span></span><br><span class="line"><span class="function"><span class="function"></span></span></span><br><span class="line"><span class="function"><span class="function">      -<span class="title">true</span></span></span></span><br><span class="line"><span class="function"><span class="function">      +<span class="title">false</span></span></span></span><br><span class="line"><span class="function"><span class="function"></span></span></span><br><span class="line"><span class="function"><span class="function">      <span class="title">at</span> <span class="title">Context</span>.&lt;<span class="title">anonymous</span>&gt; (<span class="params">D:\FrontEnd\NodeJS\node_global\node_modules\promises-aplus-tests\lib\tests\<span class="number">2.2</span><span class="number">.4</span>.js:<span class="number">51</span>:<span class="number">20</span></span>)</span></span></span><br><span class="line"><span class="function"><span class="function">      <span class="title">at</span> <span class="title">callFn</span> (<span class="params">D:\FrontEnd\NodeJS\node_global\node_modules\promises-aplus-tests\node_modules\mocha\lib\runnable.js:<span class="number">326</span>:<span class="number">21</span></span>)</span></span></span><br><span class="line"><span class="function"><span class="function">      <span class="title">at</span> <span class="title">Test</span>.<span class="title">Runnable</span>.<span class="title">run</span> (<span class="params">D:\FrontEnd\NodeJS\node_global\node_modules\promises-aplus-tests\node_modules\mocha\lib\runnable.js:<span class="number">319</span>:<span class="number">7</span></span>)</span></span></span><br><span class="line"><span class="function"><span class="function">      <span class="title">at</span> <span class="title">Runner</span>.<span class="title">runTest</span> (<span class="params">D:\FrontEnd\NodeJS\node_global\node_modules\promises-aplus-tests\node_modules\mocha\lib\runner.js:<span class="number">422</span>:<span class="number">10</span></span>)</span></span></span><br><span class="line"><span class="function"><span class="function">      <span class="title">at</span> <span class="title">D</span>:\<span class="title">FrontEnd</span>\<span class="title">NodeJS</span>\<span class="title">node_global</span>\<span class="title">node_modules</span>\<span class="title">promises</span>-<span class="title">aplus</span>-<span class="title">tests</span>\<span class="title">node_modules</span>\<span class="title">mocha</span>\<span class="title">lib</span>\<span class="title">runner</span>.<span class="title">js</span>:528:12</span></span></span><br><span class="line"><span class="function"><span class="function">      <span class="title">at</span> <span class="title">next</span> (<span class="params">D:\FrontEnd\NodeJS\node_global\node_modules\promises-aplus-tests\node_modules\mocha\lib\runner.js:<span class="number">342</span>:<span class="number">14</span></span>)</span></span></span><br><span class="line"><span class="function"><span class="function">      <span class="title">at</span> <span class="title">D</span>:\<span class="title">FrontEnd</span>\<span class="title">NodeJS</span>\<span class="title">node_global</span>\<span class="title">node_modules</span>\<span class="title">promises</span>-<span class="title">aplus</span>-<span class="title">tests</span>\<span class="title">node_modules</span>\<span class="title">mocha</span>\<span class="title">lib</span>\<span class="title">runner</span>.<span class="title">js</span>:352:7</span></span></span><br><span class="line"><span class="function"><span class="function">      <span class="title">at</span> <span class="title">next</span> (<span class="params">D:\FrontEnd\NodeJS\node_global\node_modules\promises-aplus-tests\node_modules\mocha\lib\runner.js:<span class="number">284</span>:<span class="number">14</span></span>)</span></span></span><br><span class="line"><span class="function"><span class="function">      <span class="title">at</span> <span class="title">Immediate</span>.<span class="title">_onImmediate</span> (<span class="params">D:\FrontEnd\NodeJS\node_global\node_modules\promises-aplus-tests\node_modules\mocha\lib\runner.js:<span class="number">320</span>:<span class="number">5</span></span>)</span></span></span><br><span class="line"><span class="function"><span class="function">      <span class="title">at</span> <span class="title">processImmediate</span> (<span class="params">internal/timers.js:<span class="number">461</span>:<span class="number">21</span></span>)</span></span></span><br><span class="line"><span class="function"><span class="function"></span></span></span><br><span class="line"><span class="function"><span class="function">  4) 2.2.4: `<span class="title">onFulfilled</span>` <span class="title">or</span> `<span class="title">onRejected</span>` <span class="title">must</span> <span class="title">not</span> <span class="title">be</span> <span class="title">called</span> <span class="title">until</span> <span class="title">the</span> <span class="title">execution</span> <span class="title">context</span> <span class="title">stack</span> <span class="title">contains</span> <span class="title">only</span> <span class="title">platform</span> <span class="title">code</span>. <span class="title">Clean</span>-<span class="title">stack</span> <span class="title">execution</span> <span class="title">ordering</span> <span class="title">tests</span> (<span class="params">fulfillment <span class="keyword">case</span></span>) <span class="title">when</span> <span class="title">the</span> <span class="title">promise</span> <span class="title">is</span> <span class="title">fulfilled</span> <span class="title">asynchronously</span>:</span></span></span><br><span class="line"><span class="function"><span class="function">     <span class="title">Error</span>: <span class="title">timeout</span> <span class="title">of</span> 200<span class="title">ms</span> <span class="title">exceeded</span>. <span class="title">Ensure</span> <span class="title">the</span> <span class="title">done</span>(<span class="params"></span>) <span class="title">callback</span> <span class="title">is</span> <span class="title">being</span> <span class="title">called</span> <span class="title">in</span> <span class="title">this</span> <span class="title">test</span>.</span></span></span><br><span class="line"><span class="function"><span class="function">      <span class="title">at</span> <span class="title">Timeout</span>.&lt;<span class="title">anonymous</span>&gt; (<span class="params">D:\FrontEnd\NodeJS\node_global\node_modules\promises-aplus-tests\node_modules\mocha\lib\runnable.js:<span class="number">226</span>:<span class="number">19</span></span>)</span></span></span><br><span class="line"><span class="function"><span class="function">      <span class="title">at</span> <span class="title">listOnTimeout</span> (<span class="params">internal/timers.js:<span class="number">554</span>:<span class="number">17</span></span>)</span></span></span><br><span class="line"><span class="function"><span class="function">      <span class="title">at</span> <span class="title">processTimers</span> (<span class="params">internal/timers.js:<span class="number">497</span>:<span class="number">7</span></span>)</span></span></span><br><span class="line"><span class="function"><span class="function"></span></span></span><br><span class="line"><span class="function"><span class="function">  5) 2.2.4: `<span class="title">onFulfilled</span>` <span class="title">or</span> `<span class="title">onRejected</span>` <span class="title">must</span> <span class="title">not</span> <span class="title">be</span> <span class="title">called</span> <span class="title">until</span> <span class="title">the</span> <span class="title">execution</span> <span class="title">context</span> <span class="title">stack</span> <span class="title">contains</span> <span class="title">only</span> <span class="title">platform</span> <span class="title">code</span>. <span class="title">Clean</span>-<span class="title">stack</span> <span class="title">execution</span> <span class="title">ordering</span> <span class="title">tests</span> (<span class="params">rejection <span class="keyword">case</span></span>) <span class="title">when</span> `<span class="title">onRejected</span>` <span class="title">is</span> <span class="title">added</span> <span class="title">immediately</span> <span class="title">before</span> <span class="title">the</span> <span class="title">promise</span> <span class="title">is</span> <span class="title">rejected</span>:</span></span></span><br><span class="line"><span class="function"><span class="function"></span></span></span><br><span class="line"><span class="function"><span class="function">      <span class="title">AssertionError</span> [<span class="title">ERR_ASSERTION</span>]: <span class="title">Expected</span> <span class="title">values</span> <span class="title">to</span> <span class="title">be</span> <span class="title">strictly</span> <span class="title">equal</span>:</span></span></span><br><span class="line"><span class="function"><span class="function"></span></span></span><br><span class="line"><span class="function"><span class="function"><span class="title">true</span> !== <span class="title">false</span></span></span></span><br><span class="line"><span class="function"><span class="function"></span></span></span><br><span class="line"><span class="function"><span class="function">      + <span class="title">expected</span> - <span class="title">actual</span></span></span></span><br><span class="line"><span class="function"><span class="function"></span></span></span><br><span class="line"><span class="function"><span class="function">      -<span class="title">true</span></span></span></span><br><span class="line"><span class="function"><span class="function">      +<span class="title">false</span></span></span></span><br><span class="line"><span class="function"><span class="function"></span></span></span><br><span class="line"><span class="function"><span class="function">      <span class="title">at</span> <span class="title">Context</span>.&lt;<span class="title">anonymous</span>&gt; (<span class="params">D:\FrontEnd\NodeJS\node_global\node_modules\promises-aplus-tests\lib\tests\<span class="number">2.2</span><span class="number">.4</span>.js:<span class="number">123</span>:<span class="number">20</span></span>)</span></span></span><br><span class="line"><span class="function"><span class="function">      <span class="title">at</span> <span class="title">callFn</span> (<span class="params">D:\FrontEnd\NodeJS\node_global\node_modules\promises-aplus-tests\node_modules\mocha\lib\runnable.js:<span class="number">326</span>:<span class="number">21</span></span>)</span></span></span><br><span class="line"><span class="function"><span class="function">      <span class="title">at</span> <span class="title">Test</span>.<span class="title">Runnable</span>.<span class="title">run</span> (<span class="params">D:\FrontEnd\NodeJS\node_global\node_modules\promises-aplus-tests\node_modules\mocha\lib\runnable.js:<span class="number">319</span>:<span class="number">7</span></span>)</span></span></span><br><span class="line"><span class="function"><span class="function">      <span class="title">at</span> <span class="title">Runner</span>.<span class="title">runTest</span> (<span class="params">D:\FrontEnd\NodeJS\node_global\node_modules\promises-aplus-tests\node_modules\mocha\lib\runner.js:<span class="number">422</span>:<span class="number">10</span></span>)</span></span></span><br><span class="line"><span class="function"><span class="function">      <span class="title">at</span> <span class="title">D</span>:\<span class="title">FrontEnd</span>\<span class="title">NodeJS</span>\<span class="title">node_global</span>\<span class="title">node_modules</span>\<span class="title">promises</span>-<span class="title">aplus</span>-<span class="title">tests</span>\<span class="title">node_modules</span>\<span class="title">mocha</span>\<span class="title">lib</span>\<span class="title">runner</span>.<span class="title">js</span>:528:12</span></span></span><br><span class="line"><span class="function"><span class="function">      <span class="title">at</span> <span class="title">next</span> (<span class="params">D:\FrontEnd\NodeJS\node_global\node_modules\promises-aplus-tests\node_modules\mocha\lib\runner.js:<span class="number">342</span>:<span class="number">14</span></span>)</span></span></span><br><span class="line"><span class="function"><span class="function">      <span class="title">at</span> <span class="title">D</span>:\<span class="title">FrontEnd</span>\<span class="title">NodeJS</span>\<span class="title">node_global</span>\<span class="title">node_modules</span>\<span class="title">promises</span>-<span class="title">aplus</span>-<span class="title">tests</span>\<span class="title">node_modules</span>\<span class="title">mocha</span>\<span class="title">lib</span>\<span class="title">runner</span>.<span class="title">js</span>:352:7</span></span></span><br><span class="line"><span class="function"><span class="function">      <span class="title">at</span> <span class="title">next</span> (<span class="params">D:\FrontEnd\NodeJS\node_global\node_modules\promises-aplus-tests\node_modules\mocha\lib\runner.js:<span class="number">284</span>:<span class="number">14</span></span>)</span></span></span><br><span class="line"><span class="function"><span class="function">      <span class="title">at</span> <span class="title">Immediate</span>.<span class="title">_onImmediate</span> (<span class="params">D:\FrontEnd\NodeJS\node_global\node_modules\promises-aplus-tests\node_modules\mocha\lib\runner.js:<span class="number">320</span>:<span class="number">5</span></span>)</span></span></span><br><span class="line"><span class="function"><span class="function">      <span class="title">at</span> <span class="title">processImmediate</span> (<span class="params">internal/timers.js:<span class="number">461</span>:<span class="number">21</span></span>)</span></span></span><br><span class="line"><span class="function"><span class="function"></span></span></span><br><span class="line"><span class="function"><span class="function">  6) 2.2.4: `<span class="title">onFulfilled</span>` <span class="title">or</span> `<span class="title">onRejected</span>` <span class="title">must</span> <span class="title">not</span> <span class="title">be</span> <span class="title">called</span> <span class="title">until</span> <span class="title">the</span> <span class="title">execution</span> <span class="title">context</span> <span class="title">stack</span> <span class="title">contains</span> <span class="title">only</span> <span class="title">platform</span> <span class="title">code</span>. <span class="title">Clean</span>-<span class="title">stack</span> <span class="title">execution</span> <span class="title">ordering</span> <span class="title">tests</span> (<span class="params">rejection <span class="keyword">case</span></span>) <span class="title">when</span> <span class="title">the</span> <span class="title">promise</span> <span class="title">is</span> <span class="title">rejected</span> <span class="title">asynchronously</span>:</span></span></span><br><span class="line"><span class="function"><span class="function">     <span class="title">Error</span>: <span class="title">timeout</span> <span class="title">of</span> 200<span class="title">ms</span> <span class="title">exceeded</span>. <span class="title">Ensure</span> <span class="title">the</span> <span class="title">done</span>(<span class="params"></span>) <span class="title">callback</span> <span class="title">is</span> <span class="title">being</span> <span class="title">called</span> <span class="title">in</span> <span class="title">this</span> <span class="title">test</span>.</span></span></span><br><span class="line"><span class="function"><span class="function">      <span class="title">at</span> <span class="title">Timeout</span>.&lt;<span class="title">anonymous</span>&gt; (<span class="params">D:\FrontEnd\NodeJS\node_global\node_modules\promises-aplus-tests\node_modules\mocha\lib\runnable.js:<span class="number">226</span>:<span class="number">19</span></span>)</span></span></span><br><span class="line"><span class="function"><span class="function">      <span class="title">at</span> <span class="title">listOnTimeout</span> (<span class="params">internal/timers.js:<span class="number">554</span>:<span class="number">17</span></span>)</span></span></span><br><span class="line"><span class="function"><span class="function">      <span class="title">at</span> <span class="title">processTimers</span> (<span class="params">internal/timers.js:<span class="number">497</span>:<span class="number">7</span></span>)</span></span></span><br></pre></td></tr></table></div></figure>
<p>原因是, 入对的时候没有延迟执行</p>
<figure class="highlight js"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// this.onResolvedQue.push(handleResolve)</span></span><br><span class="line"><span class="built_in">this</span>.onResolvedQue.push(<span class="function">() =&gt;</span> <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> handleResolve(), <span class="number">0</span>))</span><br><span class="line"><span class="comment">// this.onRejectedQue.push(handleReject)</span></span><br><span class="line"><span class="built_in">this</span>.onRejectedQue.push(<span class="function">() =&gt;</span> <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> handleReject(), <span class="number">0</span>))</span><br></pre></td></tr></table></div></figure>
<p>这样就过了</p>

        <h5 id="完整的合规代码"   >
          <a href="#完整的合规代码" class="heading-link"><i class="fas fa-link"></i></a>完整的合规代码</h5>
      <figure class="highlight js"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 两类三个状态</span></span><br><span class="line"><span class="keyword">const</span> PADDING = <span class="string">&#x27;PADDING&#x27;</span></span><br><span class="line"><span class="keyword">const</span> RESOLVED = <span class="string">&#x27;RESOLVED&#x27;</span></span><br><span class="line"><span class="keyword">const</span> REJECTED = <span class="string">&#x27;REJECTED&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// then返回的新promise的executor的参数执行的处理函数</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">resolvePromise</span> (<span class="params">newPromise, valueX, newResolve, newReject</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (valueX === newPromise)</span><br><span class="line">    <span class="keyword">return</span> newReject(</span><br><span class="line">      <span class="keyword">new</span> <span class="built_in">TypeError</span>(<span class="string">&#x27;Chaining cycle detected for promise #&lt;Promise&gt;&#x27;</span>)</span><br><span class="line">    )</span><br><span class="line">  <span class="keyword">let</span> called = <span class="literal">false</span></span><br><span class="line">  <span class="keyword">if</span> (</span><br><span class="line">    (valueX !== <span class="literal">null</span> &amp;&amp; <span class="keyword">typeof</span> valueX === <span class="string">&#x27;object&#x27;</span>) ||</span><br><span class="line">    <span class="keyword">typeof</span> valueX === <span class="string">&#x27;function&#x27;</span></span><br><span class="line">  ) &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="keyword">const</span> then = valueX.then</span><br><span class="line">      <span class="keyword">if</span> (<span class="keyword">typeof</span> then === <span class="string">&#x27;function&#x27;</span>) &#123;</span><br><span class="line">        then.call(</span><br><span class="line">          valueX,</span><br><span class="line">          <span class="function"><span class="params">y</span> =&gt;</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (called) <span class="keyword">return</span></span><br><span class="line">            called = <span class="literal">true</span></span><br><span class="line">            resolvePromise(newPromise, y, newResolve, newReject)</span><br><span class="line">          &#125;,</span><br><span class="line">          <span class="function"><span class="params">r</span> =&gt;</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (called) <span class="keyword">return</span></span><br><span class="line">            called = <span class="literal">true</span></span><br><span class="line">            newReject(r)</span><br><span class="line">          &#125;</span><br><span class="line">        )</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        newResolve(valueX)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">      <span class="keyword">if</span> (called) <span class="keyword">return</span></span><br><span class="line">      called = <span class="literal">true</span></span><br><span class="line">      newReject(e)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    newResolve(valueX)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyPromise</span> </span>&#123;</span><br><span class="line">  status = PADDING</span><br><span class="line">  value = <span class="literal">undefined</span></span><br><span class="line">  reason = <span class="literal">undefined</span></span><br><span class="line"></span><br><span class="line">  onResolvedQue = []</span><br><span class="line">  onRejectedQue = []</span><br><span class="line"></span><br><span class="line">  <span class="title">constructor</span> (<span class="params">executor</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> resolve = <span class="function"><span class="params">value</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (<span class="built_in">this</span>.status === PADDING) &#123;</span><br><span class="line">        <span class="built_in">this</span>.value = value</span><br><span class="line">        <span class="built_in">this</span>.status = RESOLVED</span><br><span class="line">        <span class="built_in">this</span>.onResolvedQue.forEach(<span class="function"><span class="params">fn</span> =&gt;</span> fn())</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">const</span> reject = <span class="function"><span class="params">reason</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (<span class="built_in">this</span>.status === PADDING) &#123;</span><br><span class="line">        <span class="built_in">this</span>.reason = reason</span><br><span class="line">        <span class="built_in">this</span>.status = REJECTED</span><br><span class="line">        <span class="built_in">this</span>.onRejectedQue.forEach(<span class="function"><span class="params">fn</span> =&gt;</span> fn())</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      executor(resolve, reject)</span><br><span class="line">    &#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">      reject(error)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  then (onFulfilled, onRejected) &#123;</span><br><span class="line">    onFulfilled =</span><br><span class="line">      <span class="keyword">typeof</span> onFulfilled === <span class="string">&#x27;function&#x27;</span> ? onFulfilled : <span class="function">() =&gt;</span> <span class="built_in">this</span>.value</span><br><span class="line">    onRejected =</span><br><span class="line">      <span class="keyword">typeof</span> onRejected === <span class="string">&#x27;function&#x27;</span></span><br><span class="line">        ? onRejected</span><br><span class="line">        : <span class="function">() =&gt;</span> &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="built_in">this</span>.reason</span><br><span class="line">          &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> newPromise = <span class="keyword">new</span> MyPromise(<span class="function">(<span class="params">newResolve, newReject</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">const</span> handleResolve = <span class="function">() =&gt;</span></span><br><span class="line">        <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">          <span class="keyword">try</span> &#123;</span><br><span class="line">            resolvePromise(</span><br><span class="line">              newPromise,</span><br><span class="line">              onFulfilled(<span class="built_in">this</span>.value),</span><br><span class="line">              newResolve,</span><br><span class="line">              newReject</span><br><span class="line">            )</span><br><span class="line">          &#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">            newReject(error)</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;, <span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">      <span class="keyword">const</span> handleReject = <span class="function">() =&gt;</span></span><br><span class="line">        <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">          <span class="keyword">try</span> &#123;</span><br><span class="line">            resolvePromise(</span><br><span class="line">              newPromise,</span><br><span class="line">              onRejected(<span class="built_in">this</span>.reason),</span><br><span class="line">              newResolve,</span><br><span class="line">              newReject</span><br><span class="line">            )</span><br><span class="line">          &#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">            newReject(error)</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;, <span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 都要延迟执行了, 就直接抽离出来</span></span><br><span class="line">      <span class="keyword">if</span> (<span class="built_in">this</span>.status === RESOLVED) handleResolve()</span><br><span class="line">      <span class="keyword">else</span> <span class="keyword">if</span> (<span class="built_in">this</span>.status === REJECTED) handleReject()</span><br><span class="line">      <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.onResolvedQue.push(handleResolve)</span><br><span class="line">        <span class="built_in">this</span>.onRejectedQue.push(handleReject)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">    <span class="keyword">return</span> newPromise</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">catch</span> (onRejected) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">this</span>.then(<span class="literal">undefined</span>, onRejected)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">finally</span> (onFinally) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">this</span>.then(</span><br><span class="line">      <span class="function"><span class="params">value</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> MyPromise.resolve(onFinally()).then(<span class="function">() =&gt;</span> value)</span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="function"><span class="params">reason</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> MyPromise.resolve(onFinally()).then(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">          <span class="keyword">throw</span> reason</span><br><span class="line">        &#125;)</span><br><span class="line">      &#125;</span><br><span class="line">    )</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">MyPromise.defer = MyPromise.deferred = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">let</span> dfd = &#123;&#125;</span><br><span class="line">  dfd.promise = <span class="keyword">new</span> MyPromise(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">    dfd.resolve = resolve</span><br><span class="line">    dfd.reject = reject</span><br><span class="line">  &#125;)</span><br><span class="line">  <span class="keyword">return</span> dfd</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = MyPromise</span><br></pre></td></tr></table></div></figure>
<p>全部测试用例通过</p>
<figure class="highlight shell"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">872 passing (48s)</span><br></pre></td></tr></table></div></figure>

        <h4 id="3-2-5-添加Promise的静态方法"   >
          <a href="#3-2-5-添加Promise的静态方法" class="heading-link"><i class="fas fa-link"></i></a>3.2.5 添加Promise的静态方法</h4>
      <p>then实现了, 其他就简单了</p>
<blockquote>
<ul>
<li><p><a target="_blank" rel="noopener" href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/Promise/all"><code>Promise.all(iterable)</code></a></p>
<p>这个方法返回一个新的promise对象，该promise对象在iterable参数对象里所有的promise对象都成功的时候才会触发成功，返回把一个包含iterable里所有promise返回值的数组作为成功回调的返回值，顺序跟iterable的顺序保持一致</p>
<p>如果这个新的promise对象触发了失败状态，它会把iterable里第一个触发失败的promise对象的错误信息作为它的失败错误信息。</p>
<p>Promise.all方法常被用于处理多个promise对象的状态集合。</p>
</li>
<li><p><a target="_blank" rel="noopener" href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/Promise/allSettled"><code>Promise.allSettled(iterable)</code></a></p>
<p>等到所有promises都已敲定（settled）（每个promise都已兑现（fulfilled）或已拒绝（rejected））。 返回一个promise，该promise在所有promise完成后完成。并带有一个对象数组，每个对象对应每个promise的结果。</p>
</li>
<li><p><a target="_blank" rel="noopener" href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/Promise/any"><code>Promise.any(iterable)</code></a></p>
<p>接收一个Promise对象的集合，当其中的一个 promise 成功，就返回那个成功的promise的值。</p>
</li>
<li><p><a target="_blank" rel="noopener" href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/Promise/race"><code>Promise.race(iterable)</code></a></p>
<p>当iterable参数里的任意一个子promise被成功或失败后，父promise马上也会用子promise的成功返回值或失败详情作为参数调用父promise绑定的相应句柄，并返回该promise对象。</p>
</li>
<li><p><a target="_blank" rel="noopener" href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/Promise/reject"><code>Promise.reject(reason)</code></a></p>
<p>返回一个状态为失败的Promise对象，并将给定的失败信息传递给对应的处理方法</p>
</li>
<li><p><a target="_blank" rel="noopener" href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/Promise/resolve"><code>Promise.resolve(value)</code></a></p>
<p>返回一个状态由给定value决定的Promise对象。如果该值是thenable(即，带有then方法的对象)，返回的Promise对象的最终状态由then方法执行决定；否则的话(该value为空，基本类型或者不带then方法的对象),返回的Promise对象状态为fulfilled，并且将该value传递给对应的then方法。通常而言，如果您不知道一个值是否是Promise对象，使用Promise.resolve(value) 来返回一个Promise对象,这样就能将该value以Promise对象形式使用。</p>
</li>
</ul>
</blockquote>
<p>先从简单的开始实现</p>

        <h5 id="1-Promise-resolve-和-Promise-reject"   >
          <a href="#1-Promise-resolve-和-Promise-reject" class="heading-link"><i class="fas fa-link"></i></a>1. Promise.resolve 和 Promise.reject</h5>
      <figure class="highlight js"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 将实例对象状态改为resolved</span></span><br><span class="line">MyPromise.resolve = <span class="function"><span class="params">value</span> =&gt;</span> <span class="keyword">new</span> MyPromise(<span class="function"><span class="params">resolve</span> =&gt;</span> resolve(value))</span><br><span class="line"><span class="comment">// 将实例对象状态改为rejected</span></span><br><span class="line">MyPromise.reject = <span class="function"><span class="params">reason</span> =&gt;</span> <span class="keyword">new</span> MyPromise(<span class="function">(<span class="params">_, reject</span>) =&gt;</span> reject(reason))</span><br></pre></td></tr></table></div></figure>
<p>测试</p>
<figure class="highlight js"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">MyPromise.resolve(<span class="number">123</span>).then(<span class="function"><span class="params">res</span> =&gt;</span> <span class="built_in">console</span>.log(res))</span><br><span class="line">MyPromise.reject(<span class="number">123123</span>).catch(<span class="function"><span class="params">err</span> =&gt;</span> <span class="built_in">console</span>.log(err))</span><br></pre></td></tr></table></div></figure>
<p>这时你会发现, 原生的Promise很明显慢一点, 因为resolve如果接受一个promise会等待原值进行处理, 这里我们需要修改的是构造函数中的resolve方法</p>
<figure class="highlight js"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> resolve = <span class="function"><span class="params">value</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">if</span> (value <span class="keyword">instanceof</span> MyPromise) <span class="keyword">return</span> value.then(resolve, reject)</span><br><span class="line">  <span class="keyword">if</span> (<span class="built_in">this</span>.status === PADDING) &#123;</span><br><span class="line">    <span class="built_in">this</span>.value = value</span><br><span class="line">    <span class="built_in">this</span>.status = RESOLVED</span><br><span class="line">    <span class="built_in">this</span>.onResolvedQue.forEach(<span class="function"><span class="params">fn</span> =&gt;</span> fn())</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>
<p>不用修改reject方法, 来个疯狂的测试用例</p>
<figure class="highlight js"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">MyPromise.resolve(</span><br><span class="line">  <span class="keyword">new</span> MyPromise(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">      resolve(</span><br><span class="line">        <span class="keyword">new</span> MyPromise(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">          <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">            resolve(</span><br><span class="line">              <span class="keyword">new</span> MyPromise(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">                <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">                  resolve(</span><br><span class="line">                    <span class="keyword">new</span> MyPromise(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">                      <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">                        resolve(<span class="string">&#x27;3214156&#x27;</span>)</span><br><span class="line">                      &#125;, <span class="number">1000</span>)</span><br><span class="line">                    &#125;)</span><br><span class="line">                  )</span><br><span class="line">                &#125;, <span class="number">1000</span>)</span><br><span class="line">              &#125;)</span><br><span class="line">            )</span><br><span class="line">          &#125;, <span class="number">1000</span>)</span><br><span class="line">        &#125;)</span><br><span class="line">      )</span><br><span class="line">    &#125;, <span class="number">1000</span>)</span><br><span class="line">  &#125;)</span><br><span class="line">)</span><br><span class="line">  .then(<span class="function"><span class="params">res</span> =&gt;</span> (<span class="built_in">console</span>.log(res), res))</span><br><span class="line">  .then(<span class="function"><span class="params">res</span> =&gt;</span> (<span class="built_in">console</span>.log(res), res))</span><br><span class="line">  .then(<span class="function"><span class="params">res</span> =&gt;</span> (<span class="built_in">console</span>.log(res), res))</span><br><span class="line">  .then(<span class="function"><span class="params">res</span> =&gt;</span> (<span class="built_in">console</span>.log(res), res))</span><br></pre></td></tr></table></div></figure>

        <h5 id="2-Promise-all-和-Promise-allSettled"   >
          <a href="#2-Promise-all-和-Promise-allSettled" class="heading-link"><i class="fas fa-link"></i></a>2. Promise.all 和 Promise.allSettled</h5>
      <p>这两个方法是方便并发处理的</p>
<figure class="highlight js"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">MyPromise.all = <span class="function"><span class="params">promises</span> =&gt;</span> &#123;</span><br><span class="line">  promises = <span class="built_in">Array</span>.from(promises)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> MyPromise(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">let</span> result = []</span><br><span class="line">    <span class="keyword">let</span> orderIndex = <span class="number">0</span></span><br><span class="line">    promises.forEach(<span class="function">(<span class="params">promise, index</span>) =&gt;</span> &#123;</span><br><span class="line">      MyPromise.resolve(promise).then(</span><br><span class="line">        <span class="function"><span class="params">value</span> =&gt;</span> &#123;</span><br><span class="line">          orderIndex++</span><br><span class="line">          result[index] = &#123; <span class="attr">status</span>: <span class="string">&#x27;fulfilled&#x27;</span>, value &#125;</span><br><span class="line">          <span class="keyword">if</span> (orderIndex === promises.length) resolve(result)</span><br><span class="line">        &#125;,</span><br><span class="line">        reject</span><br><span class="line">      )</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">MyPromise.allSettled = <span class="function"><span class="params">promises</span> =&gt;</span> &#123;</span><br><span class="line">  promises = <span class="built_in">Array</span>.from(promises)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> MyPromise(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">let</span> result = []</span><br><span class="line">    <span class="keyword">let</span> orderIndex = <span class="number">0</span></span><br><span class="line">    promises.forEach(<span class="function">(<span class="params">promise, index</span>) =&gt;</span> &#123;</span><br><span class="line">      MyPromise.resolve(promise).then(</span><br><span class="line">        <span class="function"><span class="params">value</span> =&gt;</span> &#123;</span><br><span class="line">          orderIndex++</span><br><span class="line">          result[index] = &#123; <span class="attr">status</span>: <span class="string">&#x27;fulfilled&#x27;</span>, value &#125;</span><br><span class="line">          <span class="keyword">if</span> (orderIndex === promises.length) resolve(result)</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="function"><span class="params">reason</span> =&gt;</span> &#123;</span><br><span class="line">          orderIndex++</span><br><span class="line">          result[index] = &#123; <span class="attr">status</span>: <span class="string">&#x27;rejected&#x27;</span>, reason &#125;</span><br><span class="line">          <span class="keyword">if</span> (orderIndex === promises.length) resolve(result)</span><br><span class="line">        &#125;</span><br><span class="line">      )</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>
<p>测试</p>
<figure class="highlight js"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> promise1 = MyPromise.resolve(<span class="number">3</span>)</span><br><span class="line"><span class="keyword">const</span> promise2 = <span class="number">42</span></span><br><span class="line"><span class="keyword">const</span> promise3 = <span class="keyword">new</span> MyPromise(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span></span><br><span class="line">  <span class="built_in">setTimeout</span>(resolve, <span class="number">100</span>, <span class="string">&#x27;foo&#x27;</span>)</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">MyPromise.all([promise1, promise2, promise3]).then(<span class="built_in">console</span>.log)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> promise4 = MyPromise.resolve(<span class="number">3</span>)</span><br><span class="line"><span class="keyword">const</span> promise5 = <span class="keyword">new</span> MyPromise(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span></span><br><span class="line">  <span class="built_in">setTimeout</span>(reject, <span class="number">1000</span>, <span class="string">&#x27;foo&#x27;</span>)</span><br><span class="line">)</span><br><span class="line">MyPromise.allSettled([promise4, promise5, <span class="number">56</span>]).then(<span class="built_in">console</span>.log)</span><br></pre></td></tr></table></div></figure>

        <h5 id="3-Promise-race-竞速方法-和-Promise-any"   >
          <a href="#3-Promise-race-竞速方法-和-Promise-any" class="heading-link"><i class="fas fa-link"></i></a>3 Promise.race(竞速方法)  和 Promise.any</h5>
      <p>这两个主要是要实现一个中断的问题</p>
<figure class="highlight js"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 执行所有promises, 如果有一个出现失误, 就返回拒绝的promise</span></span><br><span class="line">MyPromise.race = <span class="function"><span class="params">promises</span> =&gt;</span> &#123;</span><br><span class="line">  promises = <span class="built_in">Array</span>.from(promises)</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> MyPromise(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">    promises.forEach(<span class="function"><span class="params">promise</span> =&gt;</span> &#123;</span><br><span class="line">      MyPromise.resolve(promise).then(resolve, reject)</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 执行所有promises, 如果有一个成功, 就返回成功的promise</span></span><br><span class="line">MyPromise.any = <span class="function"><span class="params">promises</span> =&gt;</span> &#123;</span><br><span class="line">  promises = <span class="built_in">Array</span>.from(promises)</span><br><span class="line">  <span class="keyword">let</span> errorCount = <span class="number">0</span></span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> MyPromise(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">    promises.forEach(<span class="function"><span class="params">promise</span> =&gt;</span> &#123;</span><br><span class="line">      MyPromise.resolve(promise).then(resolve, <span class="function"><span class="params">reason</span> =&gt;</span> &#123;</span><br><span class="line">        errorCount++</span><br><span class="line">        <span class="keyword">if</span> (errorCount === promises.length)</span><br><span class="line">          reject(<span class="string">&#x27;AggregateError: No Promise in Promise.any was resolved&#x27;</span>)</span><br><span class="line">      &#125;)</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

        <h4 id="3-3-gennerator-函数-解读"   >
          <a href="#3-3-gennerator-函数-解读" class="heading-link"><i class="fas fa-link"></i></a>3.3 gennerator 函数 解读</h4>
      <p><strong>async/await实际上是对Generator（生成器）的封装</strong>，是一个语法糖。</p>

        <h5 id="3-3-1-Generator-使用"   >
          <a href="#3-3-1-Generator-使用" class="heading-link"><i class="fas fa-link"></i></a>3.3.1 Generator 使用</h5>
      <blockquote>
<ul>
<li><p><a target="_blank" rel="noopener" href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/Generator/next"><code>Generator.prototype.next()</code></a></p>
<p>返回一个由 <a target="_blank" rel="noopener" href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Operators/yield"><code>yield</code></a>表达式生成的值。</p>
</li>
<li><p><a target="_blank" rel="noopener" href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/Generator/return"><code>Generator.prototype.return()</code></a></p>
<p>返回给定的值并结束生成器。</p>
</li>
<li><p><a target="_blank" rel="noopener" href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/Generator/throw"><code>Generator.prototype.throw()</code></a></p>
<p>向生成器抛出一个错误。</p>
</li>
</ul>
</blockquote>

        <h6 id="使用"   >
          <a href="#使用" class="heading-link"><i class="fas fa-link"></i></a>使用</h6>
      <figure class="highlight js"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span>* <span class="title">generator</span>(<span class="params">i</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">yield</span> i;</span><br><span class="line">  <span class="keyword">yield</span> i + <span class="number">10</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> gen = generator(<span class="number">10</span>);</span><br><span class="line"></span><br><span class="line"><span class="built_in">console</span>.log(gen.next().value);</span><br><span class="line"><span class="comment">// expected output: 10</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">console</span>.log(gen.next().value);</span><br><span class="line"><span class="comment">// expected output: 20</span></span><br><span class="line"></span><br></pre></td></tr></table></div></figure>

        <h6 id="传参"   >
          <a href="#传参" class="heading-link"><i class="fas fa-link"></i></a>传参</h6>
      <p>调用 <code>next()</code>方法时，如果传入了参数，那么这个参数会传给<strong>上一条执行的 yield语句左边的变量</strong>，例如下面例子中的<code>x</code>：</p>
<figure class="highlight js"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> *<span class="title">createIterator</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">let</span> first = <span class="keyword">yield</span> <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">let</span> second = <span class="keyword">yield</span> first + <span class="number">2</span>; <span class="comment">// 4 + 2</span></span><br><span class="line">                                  <span class="comment">// first =4 是next(4)将参数赋给上一条的</span></span><br><span class="line">    <span class="keyword">yield</span> second + <span class="number">3</span>;             <span class="comment">// 5 + 3</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> iterator = createIterator();</span><br><span class="line"></span><br><span class="line"><span class="built_in">console</span>.log(iterator.next());    <span class="comment">// &quot;&#123; value: 1, done: false &#125;&quot;</span></span><br><span class="line"><span class="built_in">console</span>.log(iterator.next(<span class="number">4</span>));   <span class="comment">// &quot;&#123; value: 6, done: false &#125;&quot;</span></span><br><span class="line"><span class="built_in">console</span>.log(iterator.next(<span class="number">5</span>));   <span class="comment">// &quot;&#123; value: 8, done: false &#125;&quot;</span></span><br><span class="line"><span class="built_in">console</span>.log(iterator.next());    <span class="comment">// &quot;&#123; value: undefined, done: true &#125;&quot;</span></span><br></pre></td></tr></table></div></figure>

        <h6 id="返回"   >
          <a href="#返回" class="heading-link"><i class="fas fa-link"></i></a>返回</h6>
      <figure class="highlight js"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span>* <span class="title">yieldAndReturn</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">yield</span> <span class="string">&quot;Y&quot;</span>;</span><br><span class="line">  <span class="keyword">return</span> <span class="string">&quot;R&quot;</span>;<span class="comment">//显式返回处，可以观察到 done 也立即变为了 true</span></span><br><span class="line">  <span class="keyword">yield</span> <span class="string">&quot;unreachable&quot;</span>;<span class="comment">// 不会被执行了</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> gen = yieldAndReturn()</span><br><span class="line"><span class="built_in">console</span>.log(gen.next()); <span class="comment">// &#123; value: &quot;Y&quot;, done: false &#125;</span></span><br><span class="line"><span class="built_in">console</span>.log(gen.next()); <span class="comment">// &#123; value: &quot;R&quot;, done: true &#125;</span></span><br><span class="line"><span class="built_in">console</span>.log(gen.next()); <span class="comment">// &#123; value: undefined, done: true &#125;</span></span><br></pre></td></tr></table></div></figure>

        <h6 id="切换执行权"   >
          <a href="#切换执行权" class="heading-link"><i class="fas fa-link"></i></a>切换执行权</h6>
      <figure class="highlight js"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span>* <span class="title">anotherGenerator</span>(<span class="params">i</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">yield</span> i + <span class="number">1</span>;</span><br><span class="line">  <span class="keyword">yield</span> i + <span class="number">2</span>;</span><br><span class="line">  <span class="keyword">yield</span> i + <span class="number">3</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span>* <span class="title">generator</span>(<span class="params">i</span>)</span>&#123;</span><br><span class="line">  <span class="keyword">yield</span> i;</span><br><span class="line">  <span class="keyword">yield</span>* anotherGenerator(i);<span class="comment">// 移交执行权</span></span><br><span class="line">  <span class="keyword">yield</span> i + <span class="number">10</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> gen = generator(<span class="number">10</span>);</span><br><span class="line"></span><br><span class="line"><span class="built_in">console</span>.log(gen.next().value); <span class="comment">// 10</span></span><br><span class="line"><span class="built_in">console</span>.log(gen.next().value); <span class="comment">// 11</span></span><br><span class="line"><span class="built_in">console</span>.log(gen.next().value); <span class="comment">// 12</span></span><br><span class="line"><span class="built_in">console</span>.log(gen.next().value); <span class="comment">// 13</span></span><br><span class="line"><span class="built_in">console</span>.log(gen.next().value); <span class="comment">// 20</span></span><br></pre></td></tr></table></div></figure>

        <h6 id="异常"   >
          <a href="#异常" class="heading-link"><i class="fas fa-link"></i></a>异常</h6>
      <p>throw方法向该生成器抛出一个异常</p>
<figure class="highlight js"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span>* <span class="title">gen</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">while</span>(<span class="literal">true</span>) &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">       <span class="keyword">yield</span> <span class="number">42</span>;</span><br><span class="line">    &#125; <span class="keyword">catch</span>(e) &#123;</span><br><span class="line">      <span class="built_in">console</span>.log(<span class="string">&quot;Error caught!&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> g = gen();</span><br><span class="line">g.next(); <span class="comment">// &#123; value: 42, done: false &#125;</span></span><br><span class="line">g.throw(<span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">&quot;Something went wrong&quot;</span>)); <span class="comment">// &quot;Error caught!&quot;</span></span><br></pre></td></tr></table></div></figure>

        <h5 id="3-3-2-polyfill-generator"   >
          <a href="#3-3-2-polyfill-generator" class="heading-link"><i class="fas fa-link"></i></a>3.3.2  polyfill generator</h5>
      <p>使用<span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://babeljs.io/repl/#?browsers=&amp;build=&amp;builtIns=false&amp;corejs=3.6&amp;spec=false&amp;loose=false&amp;code_lz=GYVwdgxgLglg9mABAKkQcwKZgwJwIZRw6IAUMAlIgN4BQiiAnjBgDYAmiMdjz7niAakQBGAAw0AvjRoQEAZyjosiALxLs-QjhJjy02WDlwWGAHQs4aEpjCnsADyglypgG54WIDHoD0PxBj2AA4Y0BgccCBQQVEAXCLiMvLGZhZWNnaBTi7unt40fgHBoVDhiJHRcYgATOJAA&amp;debug=false&amp;forceAllTransforms=false&amp;shippedProposals=false&amp;circleciRepo=&amp;evaluate=false&amp;fileSize=false&amp;timeTravel=false&amp;sourceType=module&amp;lineWrap=true&amp;presets=es2015%2Creact%2Cstage-2&amp;prettier=false&amp;targets=&amp;version=7.5.5&amp;externalPlugins=" >babel</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span>将这段代码进行polyfill</p>
<figure class="highlight js"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> * <span class="title">generator</span> (<span class="params">i</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">yield</span> i</span><br><span class="line">  <span class="keyword">yield</span> i + <span class="number">10</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> gen = generator(<span class="number">10</span>)</span><br><span class="line"></span><br><span class="line"><span class="built_in">console</span>.log(gen.next().value)</span><br><span class="line"><span class="comment">// expected output: 10</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">console</span>.log(gen.next().value)</span><br><span class="line"><span class="comment">// expected output: 20</span></span><br></pre></td></tr></table></div></figure>
<p>得到这个结果, 尝试读一下</p>
<figure class="highlight js"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&#x27;use strict&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> _marked =</span><br><span class="line">  <span class="comment">/*#__PURE__*/</span></span><br><span class="line">  regeneratorRuntime.mark(generator) <span class="comment">// 生成一个标志,每次在闭包的高阶函数里更新这个标志的值</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">generator</span> (<span class="params">i</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// 高阶函数</span></span><br><span class="line">  <span class="keyword">return</span> regeneratorRuntime.wrap(<span class="function"><span class="keyword">function</span> <span class="title">generator$</span> (<span class="params">_context</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">while</span> (<span class="number">1</span>) &#123;</span><br><span class="line">      <span class="keyword">switch</span> (</span><br><span class="line">        (_context.prev = _context.next) <span class="comment">// 赋值语句会返回所赋的值</span></span><br><span class="line">      ) &#123;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">0</span>:</span><br><span class="line">          _context.next = <span class="number">2</span></span><br><span class="line">          <span class="keyword">return</span> i</span><br><span class="line"></span><br><span class="line">        <span class="keyword">case</span> <span class="number">2</span>:</span><br><span class="line">          _context.next = <span class="number">4</span></span><br><span class="line">          <span class="keyword">return</span> i + <span class="number">10</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">case</span> <span class="number">4</span>:</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&#x27;end&#x27;</span>:</span><br><span class="line">          <span class="keyword">return</span> _context.stop()</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;, _marked)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> gen = generator(<span class="number">10</span>)</span><br><span class="line"><span class="built_in">console</span>.log(gen.next().value) <span class="comment">// expected output: 10</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">console</span>.log(gen.next().value) <span class="comment">// expected output: 20</span></span><br></pre></td></tr></table></div></figure>
<p>代码咋一看不长，但如果仔细观察会发现有两个不认识的东西 —— <code>regeneratorRuntime.mark</code>和<code>regeneratorRuntime.wrap</code>，这两者其实是 regenerator-runtime 模块里的两个方法，regenerator-runtime 模块来自facebook的 regenerator 模块，完整代码在<span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://github.com/facebook/regenerator/blob/master/packages/regenerator-runtime/runtime.js" >runtime.js</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span>，读不动了, 看一些别人的解析吧</p>

        <h5 id="3-3-3-简易版-generator-实现"   >
          <a href="#3-3-3-简易版-generator-实现" class="heading-link"><i class="fas fa-link"></i></a>3.3.3 简易版 generator 实现</h5>
      <figure class="highlight js"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 生成器函数根据yield语句将代码分割为switch-case块，后续通过切换_context.prev和_context.next来分别执行各个case</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">gen$</span> (<span class="params">_context</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">while</span> (<span class="number">1</span>) &#123;</span><br><span class="line">    <span class="keyword">switch</span> ((_context.prev = _context.next)) &#123;</span><br><span class="line">      <span class="keyword">case</span> <span class="number">0</span>:</span><br><span class="line">        _context.next = <span class="number">2</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">&#x27;result1&#x27;</span></span><br><span class="line"></span><br><span class="line">      <span class="keyword">case</span> <span class="number">2</span>:</span><br><span class="line">        _context.next = <span class="number">4</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">&#x27;result2&#x27;</span></span><br><span class="line"></span><br><span class="line">      <span class="keyword">case</span> <span class="number">4</span>:</span><br><span class="line">        _context.next = <span class="number">6</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">&#x27;result3&#x27;</span></span><br><span class="line"></span><br><span class="line">      <span class="keyword">case</span> <span class="number">6</span>:</span><br><span class="line">      <span class="keyword">case</span> <span class="string">&#x27;end&#x27;</span>:</span><br><span class="line">        <span class="keyword">return</span> _context.stop()</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 低配版context</span></span><br><span class="line"><span class="keyword">var</span> context = &#123;</span><br><span class="line">  <span class="attr">next</span>: <span class="number">0</span>,</span><br><span class="line">  <span class="attr">prev</span>: <span class="number">0</span>,</span><br><span class="line">  <span class="attr">done</span>: <span class="literal">false</span>,</span><br><span class="line">  <span class="attr">stop</span>: <span class="function"><span class="keyword">function</span> <span class="title">stop</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="built_in">this</span>.done = <span class="literal">true</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 低配版invoke</span></span><br><span class="line"><span class="keyword">let</span> gen = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> &#123;</span><br><span class="line">    <span class="attr">next</span>: <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">      value = context.done ? <span class="literal">undefined</span> : gen$(context)</span><br><span class="line">      done = context.done</span><br><span class="line">      <span class="keyword">return</span> &#123;</span><br><span class="line">        value,</span><br><span class="line">        done</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 测试使用</span></span><br><span class="line"><span class="keyword">var</span> g = gen()</span><br><span class="line"><span class="built_in">console</span>.log(g.next()) <span class="comment">// &#123;value: &quot;result1&quot;, done: false&#125;</span></span><br><span class="line"><span class="built_in">console</span>.log(g.next()) <span class="comment">// &#123;value: &quot;result2&quot;, done: false&#125;</span></span><br><span class="line"><span class="built_in">console</span>.log(g.next()) <span class="comment">// &#123;value: &quot;result3&quot;, done: false&#125;</span></span><br><span class="line"><span class="built_in">console</span>.log(g.next()) <span class="comment">// &#123;value: undefined, done: true&#125;</span></span><br></pre></td></tr></table></div></figure>

        <h5 id="3-3-4-regeneratorRuntime-解读"   >
          <a href="#3-3-4-regeneratorRuntime-解读" class="heading-link"><i class="fas fa-link"></i></a>3.3.4 regeneratorRuntime 解读</h5>
      <p><span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://juejin.cn/post/6844904096525189128" >https://juejin.cn/post/6844904096525189128</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>

        <h4 id="3-4-模拟-async-await"   >
          <a href="#3-4-模拟-async-await" class="heading-link"><i class="fas fa-link"></i></a>3.4 模拟 async await</h4>
      <p>我们看到Generator的用法，应该️会感到很熟悉，<code>yield</code>和<code>async/await</code>看起来其实已经很相似了，它们都提供了暂停执行的功能，但二者又有三点不同：</p>
<ul>
<li><code>async/await</code>自带执行器，不需要手动调用next()就能自动执行下一步</li>
<li><code>async</code>函数返回值是Promise对象，而Generator返回的是生成器对象</li>
<li><code>await</code>能够返回Promise的resolve/reject的值</li>
</ul>
<p><strong>我们对async/await的实现，其实也就是对应以上三点封装Generator</strong></p>

        <h5 id="3-4-1-Generator-和-Promise-联动"   >
          <a href="#3-4-1-Generator-和-Promise-联动" class="heading-link"><i class="fas fa-link"></i></a>3.4.1 Generator 和 Promise 联动</h5>
      <p>假设我们要实现这样的任务</p>
<figure class="highlight js"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Promise</span>.resolve(a)</span><br><span class="line">  .then(<span class="function"><span class="params">b</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="comment">// do something</span></span><br><span class="line">  &#125;)</span><br><span class="line">  .then(<span class="function"><span class="params">c</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="comment">// do something</span></span><br><span class="line">  &#125;)</span><br></pre></td></tr></table></div></figure>
<p>使用async</p>
<figure class="highlight js"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">async</span> () =&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> a = <span class="keyword">await</span> <span class="built_in">Promise</span>.resolve(a);</span><br><span class="line">  <span class="keyword">const</span> b = <span class="keyword">await</span> <span class="built_in">Promise</span>.resolve(b);</span><br><span class="line">  <span class="keyword">const</span> c = <span class="keyword">await</span> <span class="built_in">Promise</span>.resolve(c);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>
<p>使用Generator</p>
<figure class="highlight js"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span>* <span class="title">myGenerator</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">yield</span> <span class="built_in">Promise</span>.resolve(<span class="number">1</span>);</span><br><span class="line">  <span class="keyword">yield</span> <span class="built_in">Promise</span>.resolve(<span class="number">2</span>);</span><br><span class="line">  <span class="keyword">yield</span> <span class="built_in">Promise</span>.resolve(<span class="number">3</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 手动执行迭代器</span></span><br><span class="line"><span class="keyword">const</span> gen = myGenerator()</span><br><span class="line">gen.next().value.then(<span class="function"><span class="params">val</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(val)</span><br><span class="line">  gen.next().value.then(<span class="function"><span class="params">val</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(val)</span><br><span class="line">    gen.next().value.then(<span class="function"><span class="params">val</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="built_in">console</span>.log(val)</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">//输出1 2 3</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 传值的话</span></span><br><span class="line"><span class="function"><span class="keyword">function</span>* <span class="title">myGenerator2</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="keyword">yield</span> <span class="built_in">Promise</span>.resolve(<span class="number">1</span>))   <span class="comment">//1</span></span><br><span class="line">  <span class="built_in">console</span>.log(<span class="keyword">yield</span> <span class="built_in">Promise</span>.resolve(<span class="number">2</span>))   <span class="comment">//2</span></span><br><span class="line">  <span class="built_in">console</span>.log(<span class="keyword">yield</span> <span class="built_in">Promise</span>.resolve(<span class="number">3</span>))   <span class="comment">//3</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 手动执行迭代器</span></span><br><span class="line"><span class="keyword">const</span> gen = myGenerator2()</span><br><span class="line">gen.next().value.then(<span class="function"><span class="params">val</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="comment">// console.log(val)</span></span><br><span class="line">  gen.next(val).value.then(<span class="function"><span class="params">val</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="comment">// console.log(val)</span></span><br><span class="line">    gen.next(val).value.then(<span class="function"><span class="params">val</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="comment">// console.log(val)</span></span><br><span class="line">      gen.next(val)</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br></pre></td></tr></table></div></figure>

        <h4 id="Promise-全家福"   >
          <a href="#Promise-全家福" class="heading-link"><i class="fas fa-link"></i></a>Promise 全家福</h4>
      <figure class="highlight js"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 两类三个状态</span></span><br><span class="line"><span class="keyword">const</span> PADDING = <span class="string">&#x27;PADDING&#x27;</span></span><br><span class="line"><span class="keyword">const</span> RESOLVED = <span class="string">&#x27;RESOLVED&#x27;</span></span><br><span class="line"><span class="keyword">const</span> REJECTED = <span class="string">&#x27;REJECTED&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// then返回的新promise的executor的参数执行的处理函数</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">resolvePromise</span> (<span class="params">newPromise, valueX, newResolve, newReject</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (valueX === newPromise)</span><br><span class="line">    <span class="keyword">return</span> newReject(</span><br><span class="line">      <span class="keyword">new</span> <span class="built_in">TypeError</span>(<span class="string">&#x27;Chaining cycle detected for promise #&lt;Promise&gt;&#x27;</span>)</span><br><span class="line">    )</span><br><span class="line">  <span class="keyword">let</span> called = <span class="literal">false</span></span><br><span class="line"><span class="keyword">if</span> (x !== <span class="literal">null</span> &amp;&amp; (<span class="keyword">typeof</span> x === <span class="string">&#x27;object&#x27;</span> || <span class="keyword">typeof</span> x === <span class="string">&#x27;function&#x27;</span>))  &#123;</span><br><span class="line"> &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="keyword">const</span> then = valueX.then</span><br><span class="line">      <span class="keyword">if</span> (<span class="keyword">typeof</span> then === <span class="string">&#x27;function&#x27;</span>) &#123;</span><br><span class="line">        then.call(</span><br><span class="line">          valueX,</span><br><span class="line">          <span class="function"><span class="params">y</span> =&gt;</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (called) <span class="keyword">return</span></span><br><span class="line">            called = <span class="literal">true</span></span><br><span class="line">            resolvePromise(newPromise, y, newResolve, newReject)</span><br><span class="line">          &#125;,</span><br><span class="line">          <span class="function"><span class="params">r</span> =&gt;</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (called) <span class="keyword">return</span></span><br><span class="line">            called = <span class="literal">true</span></span><br><span class="line">            newReject(r)</span><br><span class="line">          &#125;</span><br><span class="line">        )</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        newResolve(valueX)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">      <span class="keyword">if</span> (called) <span class="keyword">return</span></span><br><span class="line">      called = <span class="literal">true</span></span><br><span class="line">      newReject(e)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    newResolve(valueX)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyPromise</span> </span>&#123;</span><br><span class="line">  status = PADDING</span><br><span class="line">  value = <span class="literal">undefined</span></span><br><span class="line">  reason = <span class="literal">undefined</span></span><br><span class="line"></span><br><span class="line">  onResolvedQue = []</span><br><span class="line">  onRejectedQue = []</span><br><span class="line"></span><br><span class="line">  <span class="title">constructor</span> (<span class="params">executor</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> resolve = <span class="function"><span class="params">value</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (value <span class="keyword">instanceof</span> MyPromise) <span class="keyword">return</span> value.then(resolve, reject)</span><br><span class="line">      <span class="keyword">if</span> (<span class="built_in">this</span>.status === PADDING) &#123;</span><br><span class="line">        <span class="built_in">this</span>.value = value</span><br><span class="line">        <span class="built_in">this</span>.status = RESOLVED</span><br><span class="line">        <span class="built_in">this</span>.onResolvedQue.forEach(<span class="function"><span class="params">fn</span> =&gt;</span> fn())</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">const</span> reject = <span class="function"><span class="params">reason</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (<span class="built_in">this</span>.status === PADDING) &#123;</span><br><span class="line">        <span class="built_in">this</span>.reason = reason</span><br><span class="line">        <span class="built_in">this</span>.status = REJECTED</span><br><span class="line">        <span class="built_in">this</span>.onRejectedQue.forEach(<span class="function"><span class="params">fn</span> =&gt;</span> fn())</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      executor(resolve, reject)</span><br><span class="line">    &#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">      reject(error)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"> </span><br><span class="line">  then (onFulfilled, onRejected) &#123;</span><br><span class="line">    onFulfilled =</span><br><span class="line">      <span class="keyword">typeof</span> onFulfilled === <span class="string">&#x27;function&#x27;</span> ? onFulfilled : <span class="function">() =&gt;</span> <span class="built_in">this</span>.value</span><br><span class="line">    onRejected =</span><br><span class="line">      <span class="keyword">typeof</span> onRejected === <span class="string">&#x27;function&#x27;</span></span><br><span class="line">        ? onRejected</span><br><span class="line">        : <span class="function">() =&gt;</span> &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="built_in">this</span>.reason</span><br><span class="line">          &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> newPromise = <span class="keyword">new</span> MyPromise(<span class="function">(<span class="params">newResolve, newReject</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">const</span> handleResolve = <span class="function">() =&gt;</span></span><br><span class="line">        <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">          <span class="keyword">try</span> &#123;</span><br><span class="line">            resolvePromise(</span><br><span class="line">              newPromise,</span><br><span class="line">              onFulfilled(<span class="built_in">this</span>.value),</span><br><span class="line">              newResolve,</span><br><span class="line">              newReject</span><br><span class="line">            )</span><br><span class="line">          &#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">            newReject(error)</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;, <span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">      <span class="keyword">const</span> handleReject = <span class="function">() =&gt;</span></span><br><span class="line">        <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">          <span class="keyword">try</span> &#123;</span><br><span class="line">            resolvePromise(</span><br><span class="line">              newPromise,</span><br><span class="line">              onRejected(<span class="built_in">this</span>.reason),</span><br><span class="line">              newResolve,</span><br><span class="line">              newReject</span><br><span class="line">            )</span><br><span class="line">          &#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">            newReject(error)</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;, <span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 都要延迟执行了, 就直接抽离出来</span></span><br><span class="line">      <span class="keyword">if</span> (<span class="built_in">this</span>.status === RESOLVED) handleResolve()</span><br><span class="line">      <span class="keyword">else</span> <span class="keyword">if</span> (<span class="built_in">this</span>.status === REJECTED) handleReject()</span><br><span class="line">      <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.onResolvedQue.push(handleResolve)</span><br><span class="line">        <span class="built_in">this</span>.onRejectedQue.push(handleReject)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">    <span class="keyword">return</span> newPromise</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">catch</span> (onRejected) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">this</span>.then(<span class="literal">undefined</span>, onRejected)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">finally</span> (onFinally) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">this</span>.then(</span><br><span class="line">      <span class="function"><span class="params">value</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> MyPromise.resolve(onFinally()).then(<span class="function">() =&gt;</span> value)</span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="function"><span class="params">reason</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> MyPromise.resolve(onFinally()).then(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">          <span class="keyword">throw</span> reason</span><br><span class="line">        &#125;)</span><br><span class="line">      &#125;</span><br><span class="line">    )</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">MyPromise.resolve = <span class="function"><span class="params">value</span> =&gt;</span> <span class="keyword">new</span> MyPromise(<span class="function"><span class="params">resolve</span> =&gt;</span> resolve(value))</span><br><span class="line">MyPromise.reject = <span class="function"><span class="params">reason</span> =&gt;</span> <span class="keyword">new</span> MyPromise(<span class="function">(<span class="params">_, reject</span>) =&gt;</span> reject(reason))</span><br><span class="line"></span><br><span class="line">MyPromise.all = <span class="function"><span class="params">promises</span> =&gt;</span> &#123;</span><br><span class="line">  promises = <span class="built_in">Array</span>.from(promises)</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> MyPromise(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">let</span> result = []</span><br><span class="line">    <span class="keyword">let</span> orderIndex = <span class="number">0</span></span><br><span class="line">    promises.forEach(<span class="function">(<span class="params">promise, index</span>) =&gt;</span> &#123;</span><br><span class="line">      MyPromise.resolve(promise).then(<span class="function"><span class="params">value</span> =&gt;</span> &#123;</span><br><span class="line">        orderIndex++</span><br><span class="line">        result[index] = value</span><br><span class="line">        <span class="keyword">if</span> (orderIndex === promises.length) resolve(result)</span><br><span class="line">      &#125;, reject)</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">MyPromise.allSettled = <span class="function"><span class="params">promises</span> =&gt;</span> &#123;</span><br><span class="line">  promises = <span class="built_in">Array</span>.from(promises)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> MyPromise(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">let</span> result = []</span><br><span class="line">    <span class="keyword">let</span> orderIndex = <span class="number">0</span></span><br><span class="line">    promises.forEach(<span class="function">(<span class="params">promise, index</span>) =&gt;</span> &#123;</span><br><span class="line">      MyPromise.resolve(promise).then(</span><br><span class="line">        <span class="function"><span class="params">value</span> =&gt;</span> &#123;</span><br><span class="line">          orderIndex++</span><br><span class="line">          result[index] = &#123; <span class="attr">status</span>: <span class="string">&#x27;fulfilled&#x27;</span>, value &#125;</span><br><span class="line">          <span class="keyword">if</span> (orderIndex === promises.length) resolve(result)</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="function"><span class="params">reason</span> =&gt;</span> &#123;</span><br><span class="line">          orderIndex++</span><br><span class="line">          result[index] = &#123; <span class="attr">status</span>: <span class="string">&#x27;rejected&#x27;</span>, reason &#125;</span><br><span class="line">          <span class="keyword">if</span> (orderIndex === promises.length) resolve(result)</span><br><span class="line">        &#125;</span><br><span class="line">      )</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">MyPromise.race = <span class="function"><span class="params">promises</span> =&gt;</span> &#123;</span><br><span class="line">  promises = <span class="built_in">Array</span>.from(promises)</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> MyPromise(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">    promises.forEach(<span class="function"><span class="params">promise</span> =&gt;</span> &#123;</span><br><span class="line">      MyPromise.resolve(promise).then(resolve, reject)</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">MyPromise.any = <span class="function"><span class="params">promises</span> =&gt;</span> &#123;</span><br><span class="line">  promises = <span class="built_in">Array</span>.from(promises)</span><br><span class="line">  <span class="keyword">let</span> errorCount = <span class="number">0</span></span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> MyPromise(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">    promises.forEach(<span class="function"><span class="params">promise</span> =&gt;</span> &#123;</span><br><span class="line">      MyPromise.resolve(promise).then(resolve, <span class="function"><span class="params">reason</span> =&gt;</span> &#123;</span><br><span class="line">        errorCount++</span><br><span class="line">        <span class="keyword">if</span> (errorCount === promises.length)</span><br><span class="line">          reject(<span class="string">&#x27;AggregateError: No Promise in Promise.any was resolved&#x27;</span>)</span><br><span class="line">      &#125;)</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

        <h4 id="参考资料"   >
          <a href="#参考资料" class="heading-link"><i class="fas fa-link"></i></a>参考资料</h4>
      <p><span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://www.bilibili.com/video/BV1av411q7sb?from=search&amp;seid=10887714320688222905" >https://www.bilibili.com/video/BV1av411q7sb?from=search&amp;seid=10887714320688222905</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<p>原理最透彻 : <span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://juejin.cn/post/6924188714419634190#heading-24" >https://juejin.cn/post/6924188714419634190#heading-24</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<p><span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://juejin.cn/post/6844904096525189128#heading-11" >https://juejin.cn/post/6844904096525189128#heading-11</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<p><span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/232805664" >https://zhuanlan.zhihu.com/p/232805664</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>

        <h2 id="4-Symbol-全家桶"   >
          <a href="#4-Symbol-全家桶" class="heading-link"><i class="fas fa-link"></i></a>4. Symbol 全家桶</h2>
      
        <h3 id="4-1-分析Symbol的特点和api"   >
          <a href="#4-1-分析Symbol的特点和api" class="heading-link"><i class="fas fa-link"></i></a>4.1 分析Symbol的特点和api</h3>
      <ol>
<li><p>Symbol() 是函数，有一个可选的字符串参数, 不允许作为构造器使用，即不允许使用 new </p>
<figure class="highlight js"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Symbol</span>()</span><br><span class="line"><span class="built_in">Symbol</span>(<span class="string">&#x27;Eleme&#x27;</span>)</span><br><span class="line"><span class="keyword">new</span> <span class="built_in">Symbol</span>(<span class="string">&#x27;Eleme&#x27;</span>)  <span class="comment">// TypeError: Symbol is not a constructor</span></span><br></pre></td></tr></table></div></figure>
</li>
<li><p>返回的是原始数据类型 Symbol, 可以使用typeof来判断</p>
<figure class="highlight js"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> ELEME = <span class="built_in">Symbol</span>(<span class="string">&#x27;Eleme&#x27;</span>)</span><br><span class="line"><span class="keyword">typeof</span> ELEME  <span class="comment">// symbol</span></span><br><span class="line"><span class="built_in">console</span>.log(ELEME)  <span class="comment">// Symbol(Eleme)</span></span><br></pre></td></tr></table></div></figure>
</li>
<li><p>具有唯一性</p>
<figure class="highlight js"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Symbol</span>(<span class="string">&#x27;Eleme&#x27;</span>) === <span class="built_in">Symbol</span>(<span class="string">&#x27;Eleme&#x27;</span>)  <span class="comment">// false</span></span><br></pre></td></tr></table></div></figure>
</li>
<li><p>不允许隐式转换成字符串, 也不允许隐式转换成数字</p>
<figure class="highlight js"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&#x27;&#x27;</span> + <span class="built_in">Symbol</span>(<span class="string">&#x27;Eleme&#x27;</span>)  <span class="comment">// TypeError: Cannot convert a Symbol value to a string</span></span><br><span class="line"><span class="built_in">String</span>(<span class="built_in">Symbol</span>(<span class="string">&#x27;Eleme&#x27;</span>))  <span class="comment">// Symbol(Eleme)</span></span><br><span class="line"></span><br><span class="line"><span class="number">1</span> + <span class="built_in">Symbol</span>(<span class="string">&#x27;Eleme&#x27;</span>)  <span class="comment">// TypeError: Cannot convert a Symbol value to a number</span></span><br><span class="line"><span class="built_in">Number</span>(<span class="built_in">Symbol</span>(<span class="string">&#x27;Eleme&#x27;</span>))  <span class="comment">// TypeError: Cannot convert a Symbol value to a number</span></span><br></pre></td></tr></table></div></figure>
</li>
<li><p>有两个静态方法 for 和 keyFor</p>
<figure class="highlight js"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typeof</span> <span class="built_in">Symbol</span>.for  <span class="comment">// function</span></span><br><span class="line"><span class="keyword">typeof</span> <span class="built_in">Symbol</span>.keyFor <span class="comment">// function</span></span><br></pre></td></tr></table></div></figure>
</li>
<li><p>有几个内置的属性</p>
</li>
</ol>

        <h3 id="4-2-实现Symbol的polyfill"   >
          <a href="#4-2-实现Symbol的polyfill" class="heading-link"><i class="fas fa-link"></i></a>4.2 实现Symbol的polyfill</h3>
      <p>一共分为 4 部分的实现：</p>
<ol>
<li>构造器</li>
<li>构造器的属性</li>
<li>prototype 的属性</li>
<li>实例的属性</li>
</ol>
<p>首先解构,封装一个函数 方便使用<code>defineProperty, defineProperties</code></p>
<figure class="highlight js"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> &#123; defineProperty, defineProperties &#125; = <span class="built_in">Object</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">d</span> (<span class="params">mode, value</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// 判断属性类别, 并赋予相应的属性</span></span><br><span class="line">  <span class="keyword">const</span> map = &#123;</span><br><span class="line">    <span class="attr">c</span>: <span class="string">&#x27;configurable&#x27;</span>,</span><br><span class="line">    <span class="attr">e</span>: <span class="string">&#x27;enumerable&#x27;</span>,</span><br><span class="line">    <span class="attr">w</span>: <span class="string">&#x27;writable&#x27;</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> mode.split(<span class="string">&#x27;&#x27;</span>).reduce(</span><br><span class="line">    <span class="function">(<span class="params">desc, m</span>) =&gt;</span> &#123;</span><br><span class="line">      desc[map[m]] = <span class="literal">true</span></span><br><span class="line">      <span class="keyword">return</span> desc</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      value,</span><br><span class="line">      <span class="attr">configurable</span>: <span class="literal">false</span>,</span><br><span class="line">      <span class="attr">enumerable</span>: <span class="literal">false</span>,</span><br><span class="line">      <span class="attr">writable</span>: <span class="literal">false</span></span><br><span class="line">    &#125;</span><br><span class="line">  )</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

        <h4 id="4-2-1-构造器"   >
          <a href="#4-2-1-构造器" class="heading-link"><i class="fas fa-link"></i></a>4.2.1 构造器</h4>
      <p>首先我们应当知道，Symbol 可以作为一个函数使用，有一个可选参数，并且会执行以下 4 步：</p>
<ol>
<li>如果作为构造器，使用 new 调用，应当抛出类型错误。</li>
<li>如果没有传递参数，将描述文字设置为 undefined。</li>
<li>否则将参数转换成字符串作为描述文字。</li>
<li>返回一个唯一的 Symbol 值，它的 Description 设置为上面的描述文字。</li>
</ol>
<p>值得注意的是 <strong>Description</strong> 和 <strong>Name</strong> 实际上都不应当被外界访问到，应作为私有属性。此外，为了使 constructor 的 name 显示 Symbol 我们将简单的进行一下处理。根据这些我们可以实现以下代码，：</p>
<figure class="highlight js"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> SymbolPolyfill = <span class="function"><span class="keyword">function</span> <span class="title">Symbol</span> (<span class="params">description</span>) </span>&#123;</span><br><span class="line">  <span class="comment">/// 判断有没有被new运算符指向的方法</span></span><br><span class="line">  <span class="keyword">if</span> (<span class="built_in">this</span> <span class="keyword">instanceof</span> SymbolPolyfill)</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">TypeError</span>(<span class="string">&#x27;Symbol is not a constructor&#x27;</span>)</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 描述字符串的初始化</span></span><br><span class="line">  <span class="keyword">let</span> descString = description === <span class="literal">undefined</span> ? <span class="literal">undefined</span> : <span class="built_in">String</span>(description)</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 创建一个SymbolPolyfill对象</span></span><br><span class="line">  <span class="keyword">let</span> symbol = <span class="built_in">Object</span>.create(SymbolPolyfill.prototype)</span><br><span class="line"></span><br><span class="line">  <span class="comment">// __Description__ 和 __Name__ 实际上都不应当被外界访问到，应作为私有属性</span></span><br><span class="line">  <span class="comment">// 私有属性处理</span></span><br><span class="line">  defineProperties(symbol, &#123;</span><br><span class="line">    <span class="attr">__Description__</span>: d(<span class="string">&#x27;c&#x27;</span>, descString),</span><br><span class="line">    <span class="attr">__Name__</span>: d(<span class="string">&#x27;c&#x27;</span>, generateName(descString))</span><br><span class="line">  &#125;)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> symbol</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>
<p>其中有一个 generateName 函数，用来为每一个 Symbol 生成唯一的名字。</p>
<figure class="highlight js"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> generateName = (<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="comment">// 立即执行函数的闭包, 访问generateName直接得到的的是闭包的内容</span></span><br><span class="line">  <span class="keyword">const</span> created = &#123;&#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="function"><span class="keyword">function</span> (<span class="params">description, internal</span>) </span>&#123;</span><br><span class="line">    <span class="comment">// 如果没有就把后缀设置为1, 之后每次相同的数值出现都将后缀+1</span></span><br><span class="line">    <span class="comment">// 赋值语句将会把所赋值作为返回值</span></span><br><span class="line">    <span class="keyword">const</span> postfix = (created[description] =</span><br><span class="line">      created[description] === <span class="literal">undefined</span> ? <span class="number">1</span> : created[description] + <span class="number">1</span>)</span><br><span class="line">    <span class="keyword">return</span> <span class="string">`@@<span class="subst">$&#123;description || <span class="string">&#x27;&#x27;</span>&#125;</span><span class="subst">$&#123;postfix&#125;</span>`</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;)()</span><br></pre></td></tr></table></div></figure>
<p>这里用到了一个简单的闭包，来避免外界访问 created 这一对象。created 是用来记录已生成的 symbol 的。</p>

        <h4 id="4-2-2-构造器的属性"   >
          <a href="#4-2-2-构造器的属性" class="heading-link"><i class="fas fa-link"></i></a>4.2.2 构造器的属性</h4>
      <p>接下来，我们要设置构造器的属性。为了方便设置每个属性的 descriptor，我们先封装一个 d 函数，它可以方便我们进行快速的设置属性的 descriptor。</p>
<p>构造器的属性分为 3 种：</p>
<ol>
<li>函数：如 for 和 keyFor</li>
<li>对象：prototype</li>
<li>symbol：其他</li>
</ol>
<p>其中，for 是在全局注册了一个 symbol，keyFor 是取得这个 symbol 的 key，它们的实现较为简单，值得注意的是，规范中是用 List 来实现的，但是我们这里可以直接利用 JavaScript 的遍历性，使用 Object 作为一个映射，从而方便的进行查找等操作：</p>
<p><span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/27297604" >https://zhuanlan.zhihu.com/p/27297604</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>

        <h4 id="4-2-3-prototype的属性"   >
          <a href="#4-2-3-prototype的属性" class="heading-link"><i class="fas fa-link"></i></a>4.2.3 prototype的属性</h4>
      
        <h4 id="4-2-4-实例的属性"   >
          <a href="#4-2-4-实例的属性" class="heading-link"><i class="fas fa-link"></i></a>4.2.4 实例的属性</h4>
      <p><span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/27297604" >https://zhuanlan.zhihu.com/p/27297604</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>

        <h2 id="5-aysnc-await-generate-模拟"   >
          <a href="#5-aysnc-await-generate-模拟" class="heading-link"><i class="fas fa-link"></i></a>5. aysnc await generate 模拟</h2>
      <p>参考资料:</p>
<p><span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://blog.csdn.net/z858466/article/details/109286068" >32个手写JS</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<p><span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://blog.csdn.net/github_34708151/article/details/104285394" >前端面试 | 常见的手写代码题合集</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<p><span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://blog.csdn.net/ichangebaobao/article/details/104229814" >[前端面试]手写代码CSS &amp; JS汇总</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<p><span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://blog.csdn.net/weixin_34038293/article/details/91429971" >「中高级前端面试」JavaScript手写代码无敌秘籍</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<p><strong>Keep Curious , Keep Learning !</strong></p>
</div><footer class="post-footer"><div class="post-ending ending"><div class="ending__text">------ 本文结束，感谢您的阅读 ------</div></div><div class="post-copyright copyright"><div class="copyright-author"><span class="copyright-author__name">本文作者: </span><span class="copyright-author__value"><a href="http://zjeff-953.gitee.io/zjeff">Jeffords zuo</a></span></div><div class="copyright-link"><span class="copyright-link__name">本文链接: </span><span class="copyright-link__value"><a href="http://zjeff-953.gitee.io/zjeff/2020/12/27/%E5%A4%A7%E5%89%8D%E7%AB%AF/JavaScript%E8%BF%9B%E9%98%B6%20-%2004%20[%E5%8E%9F%E7%90%86]%E6%89%8B%E5%86%99%E5%AE%9E%E7%8E%B0XXX(%E8%BF%9B%E9%98%B6)/">http://zjeff-953.gitee.io/zjeff/2020/12/27/%E5%A4%A7%E5%89%8D%E7%AB%AF/JavaScript%E8%BF%9B%E9%98%B6%20-%2004%20[%E5%8E%9F%E7%90%86]%E6%89%8B%E5%86%99%E5%AE%9E%E7%8E%B0XXX(%E8%BF%9B%E9%98%B6)/</a></span></div><div class="copyright-notice"><span class="copyright-notice__name">版权声明: </span><span class="copyright-notice__value">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.en" rel="external nofollow" target="_blank">BY-NC-SA</a> 许可协议。转载请注明出处！</span></div></div><div class="post-tags"><span class="post-tags-item"><span class="post-tags-item__icon"><i class="fas fa-tag"></i></span><a class="post-tags-item__link" href="http://zjeff-953.gitee.io/zjeff/tags/%E9%9D%A2%E5%90%91%E5%AF%B9%E8%B1%A1/">面向对象</a></span><span class="post-tags-item"><span class="post-tags-item__icon"><i class="fas fa-tag"></i></span><a class="post-tags-item__link" href="http://zjeff-953.gitee.io/zjeff/tags/JavaScript/">JavaScript</a></span></div><nav class="post-paginator paginator"><div class="paginator-prev"><a class="paginator-prev__link" href="/2020/12/27/%E5%A4%A7%E5%89%8D%E7%AB%AF/JavaScript%E8%BF%9B%E9%98%B6%20-%2005%20%5B%E5%8E%9F%E7%90%86%5D%E6%B5%8F%E8%A7%88%E5%99%A8%E5%92%8C%E6%96%87%E6%A1%A3%E5%AF%B9%E8%B1%A1%E6%A8%A1%E5%9E%8B/"><span class="paginator-prev__icon"><i class="fas fa-angle-left"></i></span><span class="paginator-prev__text">JavaScript进阶 - 05 [原理]浏览器和文档对象模型</span></a></div><div class="paginator-next"><a class="paginator-next__link" href="/2020/12/26/%E8%BD%AF%E4%BB%B6%E5%B7%A5%E7%A8%8B/%E8%BD%AF%E4%BB%B6%E5%B7%A5%E7%A8%8B%20-%2000%20%E7%9F%A5%E8%AF%86%E6%80%BB%E7%BB%93%20%20/"><span class="paginator-prev__text">软件工程 - 00 提纲梳理</span><span class="paginator-next__icon"><i class="fas fa-angle-right"></i></span></a></div></nav></footer></div></div></div><div class="sidebar-wrap" id="sidebar-wrap"><aside class="sidebar" id="sidebar"><div class="sidebar-nav"><span class="sidebar-nav-toc current">文章目录</span><span class="sidebar-nav-ov">站点概览</span></div><section class="sidebar-toc"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#JavaScript%E8%BF%9B%E9%98%B6-04-%E5%8E%9F%E7%90%86-%E6%89%8B%E5%86%99%E5%AE%9E%E7%8E%B0XXX-%E8%BF%9B%E9%98%B6"><span class="toc-text">
          JavaScript进阶 - 04 [原理]手写实现XXX ( 进阶 )</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#3-Promise-%E5%85%A8%E5%AE%B6%E6%A1%B6"><span class="toc-text">
          3. Promise 全家桶</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#3-1-%E5%88%86%E6%9E%90%E7%89%B9%E7%82%B9%E5%92%8Capi"><span class="toc-text">
          3.1 分析特点和api</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-2-%E5%AE%9E%E7%8E%B0Promise"><span class="toc-text">
          3.2 实现Promise</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#3-2-1-%E5%AE%9E%E7%8E%B0Promise%E7%9A%84%E6%9E%84%E9%80%A0%E5%92%8Cthen-catch-finally%E8%B0%83%E7%94%A8"><span class="toc-text">
          3.2.1 实现Promise的构造和then catch finally调用</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#1-%E4%B8%89%E4%B8%AA%E7%8A%B6%E6%80%81%E7%9A%84%E8%BD%AC%E6%8D%A2%E5%92%8C%E6%9E%84%E9%80%A0%E6%96%B9%E6%B3%95%E5%AE%9E%E7%8E%B0"><span class="toc-text">
          1 三个状态的转换和构造方法实现</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2-then-%E6%96%B9%E6%B3%95"><span class="toc-text">
          2 then 方法</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#3-catch-%E6%96%B9%E6%B3%95%E5%92%8C%E5%BC%82%E5%B8%B8%E5%A4%84%E7%90%86"><span class="toc-text">
          3 catch 方法和异常处理</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#4-finally"><span class="toc-text">
          4. finally</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-2-2-Promise-A-%E7%A1%AE%E8%AE%A4"><span class="toc-text">
          3.2.2 Promise&#x2F;A+ 确认</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E8%BF%84%E4%BB%8A%E4%B8%BA%E6%AD%A2%E7%9A%84%E5%AE%9E%E7%8E%B0%E5%92%8C%E6%B5%8B%E8%AF%95%E7%94%A8%E4%BE%8B"><span class="toc-text">
          迄今为止的实现和测试用例</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-2-3-%E5%85%BC%E5%AE%B9%E5%85%B6%E4%BB%96%E7%9A%84-Promise-%E5%AE%9E%E7%8E%B0"><span class="toc-text">
          3.2.3 兼容其他的 Promise 实现</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-2-4-promises-aplus-tests-%E6%B5%8B%E8%AF%95%E5%B9%B6%E4%BF%AE%E5%A4%8D"><span class="toc-text">
          3.2.4 promises-aplus-tests 测试并修复</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%AE%8C%E6%95%B4%E7%9A%84%E5%90%88%E8%A7%84%E4%BB%A3%E7%A0%81"><span class="toc-text">
          完整的合规代码</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-2-5-%E6%B7%BB%E5%8A%A0Promise%E7%9A%84%E9%9D%99%E6%80%81%E6%96%B9%E6%B3%95"><span class="toc-text">
          3.2.5 添加Promise的静态方法</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#1-Promise-resolve-%E5%92%8C-Promise-reject"><span class="toc-text">
          1. Promise.resolve 和 Promise.reject</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2-Promise-all-%E5%92%8C-Promise-allSettled"><span class="toc-text">
          2. Promise.all 和 Promise.allSettled</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#3-Promise-race-%E7%AB%9E%E9%80%9F%E6%96%B9%E6%B3%95-%E5%92%8C-Promise-any"><span class="toc-text">
          3 Promise.race(竞速方法)  和 Promise.any</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-3-gennerator-%E5%87%BD%E6%95%B0-%E8%A7%A3%E8%AF%BB"><span class="toc-text">
          3.3 gennerator 函数 解读</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#3-3-1-Generator-%E4%BD%BF%E7%94%A8"><span class="toc-text">
          3.3.1 Generator 使用</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#3-3-2-polyfill-generator"><span class="toc-text">
          3.3.2  polyfill generator</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#3-3-3-%E7%AE%80%E6%98%93%E7%89%88-generator-%E5%AE%9E%E7%8E%B0"><span class="toc-text">
          3.3.3 简易版 generator 实现</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#3-3-4-regeneratorRuntime-%E8%A7%A3%E8%AF%BB"><span class="toc-text">
          3.3.4 regeneratorRuntime 解读</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-4-%E6%A8%A1%E6%8B%9F-async-await"><span class="toc-text">
          3.4 模拟 async await</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#3-4-1-Generator-%E5%92%8C-Promise-%E8%81%94%E5%8A%A8"><span class="toc-text">
          3.4.1 Generator 和 Promise 联动</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Promise-%E5%85%A8%E5%AE%B6%E7%A6%8F"><span class="toc-text">
          Promise 全家福</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8F%82%E8%80%83%E8%B5%84%E6%96%99"><span class="toc-text">
          参考资料</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-Symbol-%E5%85%A8%E5%AE%B6%E6%A1%B6"><span class="toc-text">
          4. Symbol 全家桶</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#4-1-%E5%88%86%E6%9E%90Symbol%E7%9A%84%E7%89%B9%E7%82%B9%E5%92%8Capi"><span class="toc-text">
          4.1 分析Symbol的特点和api</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-2-%E5%AE%9E%E7%8E%B0Symbol%E7%9A%84polyfill"><span class="toc-text">
          4.2 实现Symbol的polyfill</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#4-2-1-%E6%9E%84%E9%80%A0%E5%99%A8"><span class="toc-text">
          4.2.1 构造器</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-2-2-%E6%9E%84%E9%80%A0%E5%99%A8%E7%9A%84%E5%B1%9E%E6%80%A7"><span class="toc-text">
          4.2.2 构造器的属性</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-2-3-prototype%E7%9A%84%E5%B1%9E%E6%80%A7"><span class="toc-text">
          4.2.3 prototype的属性</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-2-4-%E5%AE%9E%E4%BE%8B%E7%9A%84%E5%B1%9E%E6%80%A7"><span class="toc-text">
          4.2.4 实例的属性</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-aysnc-await-generate-%E6%A8%A1%E6%8B%9F"><span class="toc-text">
          5. aysnc await generate 模拟</span></a></li></ol></li></ol></section><!-- ov = overview--><section class="sidebar-ov hide"><div class="sidebar-ov-author"><div class="sidebar-ov-author__avatar"><img class="sidebar-ov-author__avatar_img" src="https://gitee.com/zjeff-953/picsBed/raw/master/image/cat.jpg" alt="avatar"></div><p class="sidebar-ov-author__text">Keep Curious</p></div><div class="sidebar-ov-social"><a class="sidebar-ov-social-item" href="https://github.com/github" target="_blank" rel="noopener" data-popover="Github" data-popover-pos="up"><span class="sidebar-ov-social-item__icon"><i class="fab fa-github"></i></span></a><a class="sidebar-ov-social-item" href="https://www.zhihu.com/" target="_blank" rel="noopener" data-popover="知乎" data-popover-pos="up"><span class="sidebar-ov-social-item__icon">知</span></a><a class="sidebar-ov-social-item" href="1572754810" target="_blank" rel="noopener" data-popover="QQ" data-popover-pos="up"><span class="sidebar-ov-social-item__icon"><i class="fab fa-qq"></i></span></a><a class="sidebar-ov-social-item" href="https://gitee.com/zjeff-953" target="_blank" rel="noopener" data-popover="码云" data-popover-pos="up"><span class="sidebar-ov-social-item__icon"><i class="fab fa-git"></i></span></a></div><div class="sidebar-ov-state"><a class="sidebar-ov-state-item sidebar-ov-state-item--posts" href="/archives/"><div class="sidebar-ov-state-item__count">185</div><div class="sidebar-ov-state-item__name">归档</div></a><a class="sidebar-ov-state-item sidebar-ov-state-item--categories" href="/categories/"><div class="sidebar-ov-state-item__count">35</div><div class="sidebar-ov-state-item__name">分类</div></a><a class="sidebar-ov-state-item sidebar-ov-state-item--tags" href="/tags/"><div class="sidebar-ov-state-item__count">50</div><div class="sidebar-ov-state-item__name">标签</div></a></div><div class="sidebar-ov-cc"><a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.en" target="_blank" rel="noopener" data-popover="知识共享许可协议" data-popover-pos="up"><img src="/images/cc-by-nc-sa.svg"></a></div></section><div class="sidebar-reading"><div class="sidebar-reading-info"><span class="sidebar-reading-info__text">你已阅读了 </span><span class="sidebar-reading-info__num">0</span></div><div class="sidebar-reading-line"></div></div></aside></div><div class="clearfix"></div></div></main><footer class="footer" id="footer"><div class="footer-inner"><div><span>Copyright © 2022</span><span class="footer__icon"><i class="fas fa-heart"></i></span><span>Jeffords zuo</span></div><div><span>由 <a href="http://hexo.io/" title="Hexo" target="_blank" rel="noopener">Hexo</a> 强力驱动</span><span> v5.4.0</span><span class="footer__devider">|</span><span>主题 - <a href="https://github.com/liuyib/hexo-theme-stun/" title="Stun" target="_blank" rel="noopener">Stun</a></span><span> v2.1.1</span></div></div></footer><div class="loading-bar" id="loading-bar"><div class="loading-bar__progress"></div></div><div class="back2top" id="back2top"><span class="back2top__icon"><i class="fas fa-rocket"></i></span></div></div><script src="https://cdn.jsdelivr.net/npm/jquery@v3.4.1/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-animate@1.5.2/velocity.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-animate@1.5.2/velocity.ui.min.js"></script><script src="/js/utils.js?v=2.1.1"></script><script src="/js/stun-boot.js?v=2.1.1"></script><script src="/js/scroll.js?v=2.1.1"></script><script src="/js/header.js?v=2.1.1"></script><script src="/js/sidebar.js?v=2.1.1"></script></body></html>